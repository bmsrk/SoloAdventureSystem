@page "/worlds"
@rendermode InteractiveServer
@using System.IO
@using System.IO.Compression
@using System.Text.Json
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject SoloAdventureSystem.Web.UI.Services.WorldFileValidator FileValidator

<PageTitle>Manage Worlds</PageTitle>

<div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <h1 style="color: var(--color-text-primary); margin-bottom: 0.5rem;">Manage Worlds</h1>
        <p style="color: var(--color-text-secondary);">Browse and manage your generated game worlds</p>
    </div>

    @if (isLoading)
    {
        <Card>
            <div style="text-align: center; padding: 3rem;">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p style="color: var(--color-text-muted);">Loading worlds...</p>
            </div>
        </Card>
    }
    else if (worlds.Count == 0)
    {
        <Card>
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">&#x1F5FA;</div>
                <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">No Worlds Yet</h3>
                <p style="color: var(--color-text-secondary); margin-bottom: 2rem;">
                    You haven't generated any worlds yet. Get started by creating your first world!
                </p>
                <a href="/generate" class="custom-button btn-accent" style="text-decoration: none;">
                    Generate World
                </a>
            </div>
        </Card>
    }
    else
    {
        <div style="display: grid; gap: 1rem;">
            @foreach (var world in GetSortedWorlds())
            {
                <Card Class="world-card" Style="transition: all var(--transition-base);">
                    <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 1.5rem; align-items: start;">
                        <!-- Icon -->
                        <div class="world-icon">W</div>
                        
                        <!-- Info -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <h3 style="color: var(--color-text-primary); margin: 0;">@world.Name</h3>
                                @if (world.Validation != null)
                                {
                                    <Badge Appearance="@(world.Validation.OverallScore >= 80 ? "success" : world.Validation.OverallScore >= 50 ? "accent" : "error")">Score: @world.Validation.OverallScore</Badge>
                                    <span style="color:var(--color-text-muted); margin-left:0.5rem;">Last validated: @world.Validation.ValidatedAt.ToLocalTime().ToString("g")</span>
                                }
                                else
                                {
                                    <Badge Appearance="neutral">Not validated</Badge>
                                }
                            </div>

                            <div style="display: flex; gap: 2rem; margin-bottom: 0.75rem;">
                                <div>
                                    <span style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Created:</span>
                                    <span style="color: var(--color-text-secondary); margin-left: 0.5rem;">@world.CreatedDate.ToString("MMM dd, yyyy")</span>
                                </div>
                                <div>
                                    <span style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Size:</span>
                                    <span style="color: var(--color-text-secondary); margin-left: 0.5rem;">@FormatBytes(world.FileSize)</span>
                                </div>
                            </div>

                            @if (world.Stats != null)
                            {
                                <div style="display: flex; gap: 1.5rem;">
                                    <div class="stat-badge">
                                        <span class="stat-icon">R</span>
                                        <span class="stat-value">@world.Stats.Rooms</span>
                                        <span class="stat-label">Rooms</span>
                                    </div>
                                    <div class="stat-badge">
                                        <span class="stat-icon">N</span>
                                        <span class="stat-value">@world.Stats.NPCs</span>
                                        <span class="stat-label">NPCs</span>
                                    </div>
                                    <div class="stat-badge">
                                        <span class="stat-icon">F</span>
                                        <span class="stat-value">@world.Stats.Factions</span>
                                        <span class="stat-label">Factions</span>
                                    </div>
                                    <div class="stat-badge">
                                        <span class="stat-icon">L</span>
                                        <span class="stat-value">@world.Stats.Lore</span>
                                        <span class="stat-label">Lore</span>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <Button Appearance="accent" OnClick="@(() => ViewWorld(world))" Style="white-space: nowrap;">
                                View Details
                            </Button>
                            <Button Appearance="success" OnClick="@(() => PlayGame(world))" Style="white-space: nowrap;">
                                Play Game
                            </Button>
                            <Button Appearance="neutral" OnClick="@(() => CopyPath(world))" Style="white-space: nowrap;">
                                Copy Path
                            </Button>
                            <Button Appearance="primary" OnClick="@(() => RunValidation(world))" Style="white-space: nowrap;">Run Validation</Button>
                            <Button Appearance="danger" OnClick="@(() => ConfirmDelete(world))" Style="white-space: nowrap;">
                                Delete
                            </Button>
                        </div>
                    </div>

                    @if (world.Validation != null && world.Validation.Warnings.Any())
                    {
                        <div style="margin-top:0.75rem; color:var(--color-warning);">Warnings: @string.Join("; ", world.Validation.Warnings)</div>
                    }
                    @if (world.Validation != null && world.Validation.Errors.Any())
                    {
                        <div style="margin-top:0.75rem; color:var(--color-error);">Errors: @string.Join("; ", world.Validation.Errors)</div>
                    }
                </Card>
            }
        </div>
    }
</div>

<!-- Delete Confirmation Dialog -->
@if (showDeleteDialog && worldToDelete != null)
{
    <div class="dialog-overlay" @onclick="CancelDelete">
        <div class="dialog-content" @onclick:stopPropagation="true">
            <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">Confirm Delete</h3>
            <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">
                Are you sure you want to delete <strong style="color: var(--color-text-primary);">@worldToDelete.Name</strong>?
                <br/>
                This action cannot be undone.
            </p>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <Button Appearance="neutral" OnClick="CancelDelete">Cancel</Button>
                <Button Appearance="danger" OnClick="ConfirmDeleteWorld">Delete World</Button>
            </div>
        </div>
    </div>
}

<!-- Success Message -->
@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="toast toast-success">@successMessage</div>
}

<style>
.world-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.world-icon { width: 60px; height: 60px; background: linear-gradient(135deg, var(--color-accent-primary), var(--color-border-hover)); border-radius: var(--radius-lg); display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:var(--font-weight-bold); color:white; }
.custom-select { padding: var(--spacing-sm) var(--spacing-md); background: var(--color-bg-tertiary); color: var(--color-text-primary); border: 1px solid var(--color-border-default); border-radius: var(--radius-md); font-size: var(--font-size-sm); cursor: pointer; transition: border-color var(--transition-base); }
.spinner { width:40px; height:40px; border:4px solid var(--color-bg-elevated); border-top:4px solid var(--color-accent-primary); border-radius:50%; animation:spin 1s linear infinite; }
@@keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
.dialog-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:1000; }
.dialog-content { background: var(--color-bg-secondary); border:1px solid var(--color-border-default); border-radius:var(--radius-lg); padding:2rem; max-width:500px; box-shadow:var(--shadow-lg); }
.toast { position: fixed; bottom: 2rem; right: 2rem; padding:1rem 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index:1001; animation: slideIn 0.3s ease; }
.toast-success { background: var(--color-success); color: white; }
@@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
</style>

@code {
    private List<WorldInfo> worlds = new();
    private bool isLoading = true;
    private long totalSize = 0;
    private string sortBy = "date-desc";
    private bool showDeleteDialog = false;
    private WorldInfo? worldToDelete = null;
    private string successMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadWorlds();
    }

    private async Task LoadWorlds()
    {
        isLoading = true;
        worlds.Clear();
        totalSize = 0;
        try
        {
            var worldsPath = GetWorldsDirectory();
            if (Directory.Exists(worldsPath))
            {
                var files = Directory.GetFiles(worldsPath, "*.zip");
                foreach (var file in files)
                {
                    var info = await LoadWorldInfo(file);
                    if (info != null)
                    {
                        // try to load existing validation
                        var valPath = file + ".validation.json";
                        if (File.Exists(valPath))
                        {
                            try
                            {
                                var json = await File.ReadAllTextAsync(valPath);
                                var val = JsonSerializer.Deserialize<SoloAdventureSystem.Web.UI.Services.WorldValidationResult>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                                info.Validation = val;
                            }
                            catch { }
                        }

                        worlds.Add(info);
                        totalSize += info.FileSize;
                    }
                }
            }
        }
        catch { }
        finally { isLoading = false; }
    }

    private async Task<WorldInfo?> LoadWorldInfo(string filePath)
    {
        try
        {
            var fi = new FileInfo(filePath);
            var name = Path.GetFileNameWithoutExtension(filePath);
            var stats = new WorldStats { Rooms = 0, NPCs = 0, Factions = 0, Lore = 0 };
            try
            {
                using var zip = ZipFile.OpenRead(filePath);
                stats.Rooms = zip.Entries.Count(e => e.FullName.StartsWith("rooms/") && e.FullName.EndsWith(".json"));
                stats.NPCs = zip.Entries.Count(e => e.FullName.StartsWith("npcs/") && e.FullName.EndsWith(".json"));
                stats.Factions = zip.Entries.Count(e => e.FullName.StartsWith("factions/") && e.FullName.EndsWith(".json"));
            }
            catch { }

            return new WorldInfo { Name = name, Id = name, FilePath = filePath, FileName = fi.Name, FileSize = fi.Length, CreatedDate = fi.CreationTime, ModifiedDate = fi.LastWriteTime, Stats = stats };
        }
        catch { return null; }
    }

    private IEnumerable<WorldInfo> GetSortedWorlds()
    {
        return sortBy switch
        {
            "date-desc" => worlds.OrderByDescending(w => w.CreatedDate),
            "date-asc" => worlds.OrderBy(w => w.CreatedDate),
            "name-asc" => worlds.OrderBy(w => w.Name),
            "name-desc" => worlds.OrderByDescending(w => w.Name),
            "size-desc" => worlds.OrderByDescending(w => w.FileSize),
            "size-asc" => worlds.OrderBy(w => w.FileSize),
            _ => worlds.OrderByDescending(w => w.CreatedDate)
        };
    }

    private void OnSortChanged(ChangeEventArgs e) { sortBy = e.Value?.ToString() ?? "date-desc"; }
    private void ViewWorld(WorldInfo world) { Navigation.NavigateTo($"/worlds/{Uri.EscapeDataString(world.Id)}"); }
    private void PlayGame(WorldInfo world) { Navigation.NavigateTo($"/game/{Uri.EscapeDataString(world.Id)}"); }
    private async Task CopyPath(WorldInfo world) { await JS.InvokeVoidAsync("navigator.clipboard.writeText", world.FilePath); ShowSuccess("Path copied to clipboard!"); }

    private void ConfirmDelete(WorldInfo world) { worldToDelete = world; showDeleteDialog = true; }
    private void CancelDelete() { worldToDelete = null; showDeleteDialog = false; }
    private async Task ConfirmDeleteWorld() { if (worldToDelete == null) return; try { File.Delete(worldToDelete.FilePath); ShowSuccess($"Deleted {worldToDelete.Name}"); showDeleteDialog = false; worldToDelete = null; await LoadWorlds(); } catch { } }

    private async Task RunValidation(WorldInfo world)
    {
        try
        {
            ShowSuccess($"Running validation for {world.Name}...");
            var result = await FileValidator.ValidateWorldFileAsync(world.FilePath);
            world.Validation = result;
            // persist loaded validation is handled by validator; update UI and save
            await LoadWorlds();
            ShowSuccess($"Validation complete: {result.OverallScore}");
        }
        catch (Exception ex)
        {
            ShowSuccess($"Validation failed: {ex.Message}");
        }
    }

    private async void ShowSuccess(string message)
    {
        successMessage = message; StateHasChanged(); await Task.Delay(3000); successMessage = ""; StateHasChanged();
    }

    private string GetWorldsDirectory()
    {
        return Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "source", "repos", "SoloAdventureSystem", "content", "worlds");
    }

    private string FormatBytes(long bytes) { string[] sizes = { "B", "KB", "MB", "GB" }; double len = bytes; int order = 0; while (len >= 1024 && order < sizes.Length - 1) { order++; len /= 1024; } return $"{len:0.##} {sizes[order]}"; }

    private class WorldInfo { public string Name { get; set; } = ""; public string Id { get; set; } = ""; public string FilePath { get; set; } = ""; public string FileName { get; set; } = ""; public long FileSize { get; set; } public DateTime CreatedDate { get; set; } public DateTime ModifiedDate { get; set; } public WorldStats? Stats { get; set; } public SoloAdventureSystem.Web.UI.Services.WorldValidationResult? Validation { get; set; } }
    private class WorldStats { public int Rooms { get; set; } public int NPCs { get; set; } public int Factions { get; set; } public int Lore { get; set; } }
}

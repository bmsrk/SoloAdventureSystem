@page "/game/{seed}"
@rendermode InteractiveServer
@using System.IO
@using System.IO.Compression
@using System.Text.Json
@using SoloAdventureSystem.Engine.Models
@using SoloAdventureSystem.Engine.Game
@using SoloAdventureSystem.Engine.WorldLoader
@using SoloAdventureSystem.Engine.Rules
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Playing @world?.WorldDefinition?.Name ?? "Game"</PageTitle>

<div style="padding: 2rem; width: 100%; max-width: none; box-sizing: border-box; margin: 0 auto;">
    @if (isLoading)
    {
        <Card>
            <div style="text-align: center; padding: 3rem;">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p style="color: var(--color-text-muted);">Loading game...</p>
            </div>
        </Card>
    }
    else if (world == null)
    {
        <Card>
            <div style="text-align: center; padding: 3rem;">
                <div class="error-icon">!</div>
                <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">World Not Found</h3>
                <p style="color: var(--color-text-secondary); margin-bottom: 2rem;">
                    The world you're trying to play doesn't exist or has been deleted.
                </p>
                <a href="/worlds" class="custom-button btn-neutral" style="text-decoration: none;">
                    Back to Worlds
                </a>
            </div>
        </Card>
    }
    else
    {
        <!-- Header -->
        <div style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                    <a href="/worlds" style="color: var(--color-text-muted); text-decoration: none; font-size: var(--font-size-sm);">
                        &larr; Back to Worlds
                    </a>
                    <h1 style="color: var(--color-text-primary); margin: 0.5rem 0;">Playing @world.WorldDefinition.Name</h1>
                    <p style="color: var(--color-text-secondary); margin: 0;">
                        Turn: @gameState.TurnCount | HP: @gameState.Player.HP/@gameState.Player.MaxHP
                    </p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <Button Appearance="neutral" OnClick="ShowStats">Stats</Button>
                    <Button Appearance="neutral" OnClick="ShowInventory">Inventory</Button>
                    <Button Appearance="danger" OnClick="QuitGame">Quit</Button>
                </div>
            </div>
        </div>

        <!-- Game Layout -->
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
            <!-- Main Game Area -->
            <div>
                <!-- Location -->
                <Card Style="margin-bottom: 1.5rem;">
                    <!-- Make description area scrollable with fixed max-height -->
                    <div style="padding: 1.5rem; max-height: 420px; overflow-y: auto; overflow-x: hidden;">
                        <h3 style="color: var(--color-accent-primary); margin-bottom: 1rem;">@gameState.CurrentLocation.Name</h3>
                        <p style="color: var(--color-text-secondary); line-height: 1.6; white-space: pre-wrap;">@GetLocationDescription()</p>
                    </div>
                </Card>

                <!-- Actions -->
                <Card>
                    <div style="padding: 1.5rem;">
                        <h4 style="color: var(--color-accent-primary); margin-bottom: 1rem;">Available Actions</h4>
                        <!-- Make action list scrollable -->
                        <div style="max-height: 320px; overflow-y: auto; display: grid; gap: 0.5rem;">
                            @foreach (var action in availableActions)
                            {
                                <Button Appearance="accent" 
                                        OnClick="() => ExecuteAction(action)"
                                        Style="width: 100%; text-align: left; justify-content: flex-start;">
                                    @action
                                </Button>
                            }
                        </div>
                    </div>
                </Card>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Quick Actions -->
                <Card Style="margin-bottom: 1.5rem;">
                    <div style="padding: 1.5rem;">
                        <h4 style="color: var(--color-accent-primary); margin-bottom: 1rem;">Quick Actions</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <Button Appearance="neutral" OnClick="LookAround" Style="width: 100%;">Look Around</Button>
                        </div>
                    </div>
                </Card>

                <!-- Player Info -->
                <Card>
                    <div style="padding: 1.5rem;">
                        <h4 style="color: var(--color-accent-primary); margin-bottom: 1rem;">Player</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div><strong>Name:</strong> @gameState.Player.Name</div>
                            <div><strong>HP:</strong> @gameState.Player.HP/@gameState.Player.MaxHP</div>
                            <div><strong>Items:</strong> @gameState.Inventory.Count</div>
                            <div><strong>Quests:</strong> @gameState.Player.ActiveQuests.Count</div>
                        </div>
                    </div>
                </Card>
            </div>
        </div>

        <!-- Debug: show loaded story nodes and choices for current room only -->
        @if (world?.StoryNodes != null)
        {
            var roomNodes = GetRoomStoryNodes().ToList();
            <Card Style="margin-bottom: 1rem;">
                <div style="padding: 1rem;">
                    <h5 style="color: var(--color-text-primary); margin: 0 0 0.5rem 0;">Dialogue Index (Debug) - This Room</h5>
                    @if (roomNodes.Count == 0)
                    {
                        <div style="color: var(--color-text-muted);">No story nodes attached to this room.</div>
                    }
                    else
                    {
                        <div style="max-height: 200px; overflow-y: auto;">
                            @foreach (var sn in roomNodes)
                            {
                                <div style="padding: 0.5rem; border-bottom: 1px solid var(--color-border-default);">
                                    <div><strong>ID:</strong> @sn.Id</div>
                                    <div><strong>Title:</strong> @sn.Title</div>
                                    <div style="margin-top: 0.25rem;"><strong>Choices:</strong></div>
                                    @if (sn.Choices != null && sn.Choices.Count > 0)
                                    {
                                        <ul style="margin:0 0 0.5rem 1rem; padding:0; color: var(--color-text-secondary);">
                                            @foreach (var c in sn.Choices)
                                            {
                                                <li>@c.Label <span style="color: var(--color-text-muted);">? @c.Next</span></li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <div style="color: var(--color-text-muted);">(no choices)</div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </Card>
        }
    }
</div>

<!-- Dialogue Modal -->
@if (showDialogueModal && currentStoryNode != null)
{
    <div class="modal-overlay" @onclick="CloseDialogue">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">@currentStoryNode.Title</h3>
            <p style="color: var(--color-text-secondary); white-space: pre-wrap;">@currentStoryNode.Text</p>

            <div style="margin-top: 1rem; display: grid; gap: 0.5rem;">
                @foreach (var ch in currentStoryNode.Choices)
                {
                    <Button Appearance="accent" OnClick="() => OnDialogueChoiceSelected(ch)">
                        @ch.Label
                    </Button>
                }
            </div>

            @if (!string.IsNullOrEmpty(dialogueOutcome))
            {
                <div style="margin-top: 1rem; color: var(--color-text-secondary);">@dialogueOutcome</div>
            }

            <div style="margin-top: 1.5rem; text-align: right;">
                <Button Appearance="neutral" OnClick="CloseDialogue">Close</Button>
            </div>
        </div>
    </div>
}

<!-- Stats Modal -->
@if (showStatsModal)
{
    <div class="modal-overlay" @onclick="CloseStatsModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">Character Stats</h3>
            <div style="display: grid; gap: 1rem;">
                <div>
                    <h5>Attributes</h5>
                    @foreach (var attr in gameState.Player.Attributes)
                    {
                        <div>@attr.Key: @attr.Value</div>
                    }
                </div>
                <div>
                    <h5>Skills</h5>
                    @foreach (var skill in gameState.Player.Skills)
                    {
                        <div>@skill.Key: @skill.Value</div>
                    }
                </div>
                <div>
                    <h5>Equipment</h5>
                    @if (gameState.Player.Equipment.Any())
                    {
                        @foreach (var item in gameState.Player.Equipment)
                        {
                            <div>@item</div>
                        }
                    }
                    else
                    {
                        <div>No equipment</div>
                    }
                </div>
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                <Button Appearance="neutral" OnClick="CloseStatsModal">Close</Button>
            </div>
        </div>
    </div>
}

<!-- Inventory Modal -->
@if (showInventoryModal)
{
    <div class="modal-overlay" @onclick="CloseInventoryModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">Inventory</h3>
            @if (gameState.Inventory.Any())
            {
                <div style="display: grid; gap: 0.5rem;">
                    @foreach (var item in gameState.Inventory)
                    {
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--color-bg-primary); border-radius: var(--radius-sm);">
                            <span>@item</span>
                            <Button Appearance="accent" Size="small" OnClick="() => UseItem(item)">Use</Button>
                        </div>
                    }
                </div>
            }
            else
            {
                <div style="text-align: center; color: var(--color-text-muted); padding: 2rem;">Your inventory is empty.</div>
            }
            <div style="margin-top: 1.5rem; text-align: right;">
                <Button Appearance="neutral" OnClick="CloseInventoryModal">Close</Button>
            </div>
        </div>
    </div>
}

<!-- Message Modal -->
@if (!string.IsNullOrEmpty(message))
{
    <div class="modal-overlay" @onclick="CloseMessage">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">Message</h3>
            <p style="color: var(--color-text-secondary); white-space: pre-wrap;">@message</p>
            <div style="margin-top: 1.5rem; text-align: right;">
                <Button Appearance="accent" OnClick="CloseMessage">Continue</Button>
            </div>
        </div>
    </div>
}

<style>
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--color-bg-elevated);
    border-top: 4px solid var(--color-accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1rem;
    background: var(--color-error);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: white;
    font-weight: var(--font-weight-bold);
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-default);
    border-radius: var(--radius-lg);
    padding: 2rem;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}
</style>

@code {
    [Parameter]
    public string Seed { get; set; } = "";
    
    private WorldModel? world;
    private GameState gameState = new();
    private bool isLoading = true;
    private List<string> availableActions = new();
    private bool showStatsModal = false;
    private bool showInventoryModal = false;
    private string message = "";

    // Dialogue state
    private bool showDialogueModal = false;
    private StoryNode? currentStoryNode;
    private string dialogueOutcome = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadWorld();
        if (world != null)
        {
            InitializeGame();
        }
    }

    private async Task LoadWorld()
    {
        isLoading = true;
        
        try
        {
            var worldsPath = GetWorldsDirectory();
            var files = Directory.GetFiles(worldsPath, $"*_{Seed}.zip");
            
            if (files.Length > 0)
            {
                var filePath = files[0];
                
                using var zip = ZipFile.OpenRead(filePath);
                
                // Read world.json for metadata
                var worldEntry = zip.GetEntry("world.json");
                if (worldEntry != null)
                {
                    using var stream = worldEntry.Open();
                    using var reader = new StreamReader(stream);
                    var json = await reader.ReadToEndAsync();
                    
                    var worldMetadata = JsonSerializer.Deserialize<WorldJsonModel>(json, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    
                    if (worldMetadata != null)
                    {
                        world = new WorldModel
                        {
                            WorldDefinition = new WorldDefinition(
                                worldMetadata.Name,
                                worldMetadata.Description,
                                worldMetadata.Version,
                                worldMetadata.Author,
                                worldMetadata.CreatedAt,
                                worldMetadata.StartLocationId,
                                worldMetadata.LocationIds,
                                worldMetadata.NpcIds,
                                worldMetadata.ItemIds,
                                worldMetadata.FactionIds,
                                worldMetadata.StoryNodeIds
                            ),
                            Rooms = new List<Location>(),
                            Npcs = new List<NPC>(),
                            Factions = new List<Faction>(),
                            Events = new List<EventModel>(),
                            StoryNodes = new List<StoryNode>()
                        };
                    }
                }
                
                if (world == null) return;
                
                // Read all rooms
                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("rooms/") && e.FullName.EndsWith(".json")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var roomJson = await reader.ReadToEndAsync();
                    var room = JsonSerializer.Deserialize<RoomModel>(roomJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    if (room != null)
                    {
                        world.Rooms.Add(new Location(
                            room.Id,
                            room.Title,
                            room.BaseDescription,
                            room.Exits ?? new Dictionary<string, string>(),
                            room.Npcs ?? new List<string>(),
                            room.Items ?? new List<string>()
                        ));
                    }
                }
                
                // Read all NPCs
                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("npcs/") && e.FullName.EndsWith(".json")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var npcJson = await reader.ReadToEndAsync();
                    var npc = JsonSerializer.Deserialize<NpcModel>(npcJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    if (npc != null)
                    {
                        world.Npcs.Add(new NPC(
                            npc.Id,
                            npc.Name,
                            npc.Description,
                            npc.FactionId,
                            Enum.Parse<Hostility>(npc.Hostility, true),
                            new Attributes(
                                npc.Attributes.Strength,
                                npc.Attributes.Dexterity,
                                npc.Attributes.Intelligence,
                                npc.Attributes.Constitution,
                                npc.Attributes.Wisdom,
                                npc.Attributes.Charisma
                            ),
                            Enum.Parse<Behavior>(npc.Behavior, true),
                            npc.Inventory
                        ));
                    }
                }
                
                // Read all factions
                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("factions/") && e.FullName.EndsWith(".json")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var factionJson = await reader.ReadToEndAsync();
                    var faction = JsonSerializer.Deserialize<FactionModel>(factionJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    if (faction != null)
                    {
                        world.Factions.Add(new Faction(
                            faction.Id,
                            faction.Name,
                            faction.Description,
                            faction.Ideology,
                            faction.Relations ?? new Dictionary<string, int>()
                        ));
                    }
                }

                // Read story nodes (YAML)
                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("story/") && e.FullName.EndsWith(".yaml")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var yaml = await reader.ReadToEndAsync();
                    try
                    {
                        // First try to deserialize with the generator's model for better fidelity
                        try
                        {
                            var deserializer = new YamlDotNet.Serialization.DeserializerBuilder()
                                .IgnoreUnmatchedProperties()
                                .Build();

                            var genNode = deserializer.Deserialize<SoloAdventureSystem.ContentGenerator.Models.StoryNodeModel>(yaml);
                            if (genNode != null)
                            {
                                var engineNode = new StoryNode
                                {
                                    Id = genNode.Id ?? string.Empty,
                                    Title = genNode.Title ?? string.Empty,
                                    Text = genNode.Text ?? string.Empty,
                                    Choices = new List<StoryChoice>()
                                };

                                if (genNode.Choices != null)
                                {
                                    foreach (var gc in genNode.Choices)
                                    {
                                        var sc = gc.SkillCheck != null ? new SkillCheck
                                        {
                                            Attribute = gc.SkillCheck.Attribute,
                                            Skill = gc.SkillCheck.Skill,
                                            TargetNumber = gc.SkillCheck.TargetNumber,
                                            OpponentNpcId = gc.SkillCheck.OpponentNpcId ?? string.Empty
                                        } : null;

                                        var choice = new StoryChoice
                                        {
                                            Label = gc.Label ?? string.Empty,
                                            Next = gc.Next ?? string.Empty,
                                            Effects = gc.Effects ?? new List<string>(),
                                            SkillCheck = sc
                                        };

                                        engineNode.Choices.Add(choice);
                                    }
                                }

                                world.StoryNodes.Add(engineNode);
                                continue;
                            }
                        }
                        catch (Exception) { /* fall back to loader */ }

                        var loader = new WorldLoaderService();
                        var node = loader.ParseStoryNode(yaml);
                        if (node != null) world.StoryNodes.Add(node);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Failed to parse story node {entry.FullName}: {ex.Message}");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading world: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void InitializeGame()
    {
        if (world?.WorldDefinition == null) return;

        gameState.World = world;
        var startLocation = world.Rooms?.FirstOrDefault(l => l.Id == world.WorldDefinition.StartLocationId);
        if (startLocation != null)
        {
            gameState.CurrentLocation = startLocation;
        }
        gameState.Player = new PlayerCharacter();
        gameState.TurnCount = 0;

        UpdateAvailableActions();
    }

    private void UpdateAvailableActions()
    {
        availableActions.Clear();

        // Movement options
        if (gameState.CurrentLocation.Connections?.Count > 0)
        {
            foreach (var connection in gameState.CurrentLocation.Connections)
            {
                availableActions.Add($"Go {connection.Key}");
            }
        }

        // Interaction options
        if (gameState.CurrentLocation.NpcIds?.Count > 0)
        {
            var npcs = gameState.World.Npcs?
                .Where(n => gameState.CurrentLocation.NpcIds.Contains(n.Id))
                .ToList();
            
            if (npcs?.Count > 0)
            {
                foreach (var npc in npcs)
                {
                    availableActions.Add($"Talk to {npc.Name}");
                    if (npc.Hostility == Hostility.Hostile)
                    {
                        availableActions.Add($"Attack {npc.Name}");
                    }
                }
            }
        }

        // Item options
        if (gameState.CurrentLocation.ItemIds?.Count > 0)
        {
            foreach (var itemId in gameState.CurrentLocation.ItemIds)
            {
                availableActions.Add($"Take {itemId}");
            }
        }

        // Inventory use options
        if (gameState.Inventory.Count > 0)
        {
            foreach (var itemId in gameState.Inventory)
            {
                availableActions.Add($"Use {itemId}");
            }
        }

        StateHasChanged();
    }

    private void ExecuteAction(string action)
    {
        gameState.TurnCount++;

        if (action.StartsWith("Go "))
        {
            var direction = action.Substring(3);
            MoveToLocation(direction);
        }
        else if (action.StartsWith("Talk to "))
        {
            var npcName = action.Substring(8);
            TalkToNPC(npcName);
        }
        else if (action.StartsWith("Attack "))
        {
            var npcName = action.Substring(7);
            AttackNPC(npcName);
        }
        else if (action.StartsWith("Take "))
        {
            var itemName = action.Substring(5);
            TakeItem(itemName);
        }
        else if (action.StartsWith("Use "))
        {
            var itemName = action.Substring(4);
            UseItem(itemName);
        }

        UpdateAvailableActions();
    }

    private void MoveToLocation(string direction)
    {
        if (gameState.CurrentLocation.Connections?.TryGetValue(direction, out var locationId) == true)
        {
            var newLocation = gameState.World.Rooms?.FirstOrDefault(l => l.Id == locationId);
            if (newLocation != null)
            {
                gameState.CurrentLocation = newLocation;
                ShowMessage($"You travel {direction}.");
            }
        }
    }

    private void TalkToNPC(string npcName)
    {
        var npc = gameState.World.Npcs?.FirstOrDefault(n => 
            n.Name == npcName && gameState.CurrentLocation.NpcIds?.Contains(n.Id) == true);
        
        if (npc != null)
        {
            // Try to find a pre-generated story node for dialogue using several heuristics
            var nodes = gameState.World.StoryNodes ?? new List<StoryNode>();

            StoryNode? node = null;

            // 1) Exact generator convention: dialogue_{npcId}_*
            node = nodes.FirstOrDefault(s => s.Id.StartsWith($"dialogue_{npc.Id}_", StringComparison.OrdinalIgnoreCase));

            // 2) ID contains npc id (fallback)
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Id.IndexOf(npc.Id, StringComparison.OrdinalIgnoreCase) >= 0);

            // 3) Text mentions NPC name
            if (node == null)
                node = nodes.FirstOrDefault(s => !string.IsNullOrEmpty(s.Text) && s.Text.IndexOf(npc.Name ?? "", StringComparison.OrdinalIgnoreCase) >= 0);

            // 4) Skill checks reference opponent npc id
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Choices != null && s.Choices.Any(c => c.SkillCheck != null && string.Equals(c.SkillCheck.OpponentNpcId, npc.Id, StringComparison.OrdinalIgnoreCase)));

            // 5) Effects reference the npc id or daemon tag
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Choices != null && s.Choices.Any(c => c.Effects != null && c.Effects.Any(e => e.IndexOf(npc.Id, StringComparison.OrdinalIgnoreCase) >= 0 || e.IndexOf($"Daemon:{npc.Id}", StringComparison.OrdinalIgnoreCase) >= 0)));

            // 6) Last resort: any dialogue_ node at this location
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Id.StartsWith("dialogue_") );

            if (node != null)
            {
                currentStoryNode = node;
                dialogueOutcome = string.Empty;
                showDialogueModal = true;
                StateHasChanged();
                return;
            }
            
            // Fallback: show basic description and log that no dialogue node was found for this NPC
            try
            {
                Console.WriteLine($"No story node found for NPC {npc.Id} ({npc.Name}) in this world. Available story nodes: {gameState.World.StoryNodes?.Count ?? 0}");
            }
            catch { /* swallow logging errors in UI */ }

            var description = npc.Description ?? "They have nothing to say.";
            var name = npc.Name ?? "Someone";
            var message = $"\"{description}\"\n\n- {name}";
            ShowMessage(message);
         }
     }

    private void OnDialogueChoiceSelected(StoryChoice choice)
    {
        dialogueOutcome = string.Empty;

        // If there's a skill check, resolve it
        if (choice.SkillCheck != null)
        {
            var sc = choice.SkillCheck;

            var playerAttributes = gameState.Player.Attributes;
            var playerSkills = gameState.Player.Skills;
            var playerDaemon = gameState.GetDaemonFor("player");

            var outcome = DaemonDialogue.ResolveSkillCheck(playerAttributes, playerSkills, playerDaemon,
                sc.Attribute, sc.Skill, sc.TargetNumber);

            // Build detailed roll info
            var diceStr = outcome.Roll.Dice != null && outcome.Roll.Dice.Count > 0
                ? string.Join(", ", outcome.Roll.Dice)
                : "";

            // daemon modifier (for display) - safe default
            var daemonMod = playerDaemon?.GetSkillModifier(sc.Skill) ?? 0;

            var baseTotal = outcome.Roll.Total;
            var modifiedTotal = outcome.ModifiedTotal;

            var critNote = outcome.CriticalSuccess ? " (Critical Success)" : outcome.CriticalFailure ? " (Critical Failure)" : string.Empty;

            dialogueOutcome = $"Roll: [{diceStr}] -> base {baseTotal}; Daemon mod: {daemonMod}; Modified: {modifiedTotal} vs Target: {sc.TargetNumber}{critNote}";

            if (outcome.Success)
            {
                dialogueOutcome = "Success! " + dialogueOutcome;
                // Apply effects
                foreach (var eff in choice.Effects ?? new List<string>())
                {
                    DaemonDialogue.ApplyEffect(gameState, eff);
                }

                // Navigate to Next node
                NavigateToStoryNode(choice.Next);
                return;
            }
            else
            {
                dialogueOutcome = "Failure. " + dialogueOutcome;
                // apply failure effect if any
                foreach (var eff in choice.Effects ?? new List<string>())
                {
                    // Optionally apply negative or partial effects - for now apply same
                    DaemonDialogue.ApplyEffect(gameState, eff);
                }

                // Navigate to a hostile or fallback node if exists
                var hostile = gameState.World.StoryNodes?.FirstOrDefault(s => s.Id.Contains("hostile") || s.Id.Contains("dialogue_hostile"));
                if (hostile != null)
                {
                    currentStoryNode = hostile;
                    StateHasChanged();
                    return;
                }
                else
                {
                    NavigateToStoryNode(choice.Next);
                    return;
                }
            }
        }
        else
        {
            // No skill check, apply effects and navigate
            foreach (var eff in choice.Effects ?? new List<string>())
            {
                DaemonDialogue.ApplyEffect(gameState, eff);
            }
            NavigateToStoryNode(choice.Next);
            return;
        }
    }

    private void NavigateToStoryNode(string nextId)
    {
        if (string.IsNullOrEmpty(nextId) || nextId == "end")
        {
            // close dialogue
            showDialogueModal = false;
            currentStoryNode = null;
            StateHasChanged();
            return;
        }

        var next = gameState.World.StoryNodes?.FirstOrDefault(s => s.Id == nextId);
        if (next != null)
        {
            currentStoryNode = next;
        }
        else
        {
            // missing node -> close
            showDialogueModal = false;
            currentStoryNode = null;
        }

        StateHasChanged();
    }

    private void AttackNPC(string npcName)
    {
        var npc = gameState.World.Npcs?.FirstOrDefault(n => 
            n.Name == npcName && gameState.CurrentLocation.NpcIds?.Contains(n.Id) == true);
        
        if (npc != null)
        {
            var playerStats = gameState.Player.ToCharacterStats();
            var npcAttributes = new Dictionary<GameAttribute, int>
            {
                [GameAttribute.Body] = npc.Attributes.Strength,
                [GameAttribute.Mind] = npc.Attributes.Intelligence,
                [GameAttribute.Soul] = npc.Attributes.Wisdom,
                [GameAttribute.Presence] = npc.Attributes.Charisma
            };
            var npcSkills = new Dictionary<Skill, int>
            {
                [Skill.Combat] = 0,
                [Skill.Stealth] = 0,
                [Skill.Knowledge] = 0,
                [Skill.Awareness] = 0,
                [Skill.Social] = 0,
                [Skill.Will] = 0,
                [Skill.Occult] = 0
            };
            var npcStats = new CharacterStats(npcAttributes, npcSkills, 10, 6);

            var attackResult = RuleEngine.RollCombatAttack(playerStats, npcStats);
            
            if (attackResult.Hit)
            {
                var damageResult = RuleEngine.RollDamage(DamageType.Unarmed);
                ShowMessage($"You hit {npcName} for {damageResult.Damage} damage!\n\nThe {npcName} is defeated.");
                gameState.CurrentLocation.NpcIds?.Remove(npc.Id);
            }
            else
            {
                ShowMessage($"You miss {npcName}.");
            }
        }
    }

    private void TakeItem(string itemName)
    {
        if (gameState.CurrentLocation.ItemIds?.Contains(itemName) == true)
        {
            gameState.Inventory.Add(itemName);
            gameState.CurrentLocation.ItemIds?.Remove(itemName);
            ShowMessage($"You take the {itemName}.");
        }
    }

    private void UseItem(string itemName)
    {
        if (gameState.Inventory.Contains(itemName))
        {
            ShowMessage($"You use the {itemName}.");
        }
    }

    private void LookAround()
    {
        var locationName = gameState.CurrentLocation.Name ?? "Unknown Location";
        var description = gameState.CurrentLocation.Description ?? "You see nothing of interest.";
        ShowMessage($"You look around {locationName}.\n\n{description}");
    }

    private void ShowStats()
    {
        showStatsModal = true;
        StateHasChanged();
    }

    private void CloseStatsModal()
    {
        showStatsModal = false;
        StateHasChanged();
    }

    private void ShowInventory()
    {
        showInventoryModal = true;
        StateHasChanged();
    }

    private void CloseInventoryModal()
    {
        showInventoryModal = false;
        StateHasChanged();
    }

    private void CloseDialogue()
    {
        showDialogueModal = false;
        currentStoryNode = null;
        dialogueOutcome = string.Empty;
        StateHasChanged();
    }

    private void ShowMessage(string msg)
    {
        message = msg;
        StateHasChanged();
    }

    private void CloseMessage()
    {
        message = "";
        StateHasChanged();
    }

    private void QuitGame()
    {
        Navigation.NavigateTo("/worlds");
    }

    private string GetLocationDescription()
    {
        var description = gameState.CurrentLocation.Description;
        
        // Add NPCs info
        if (gameState.CurrentLocation.NpcIds?.Count > 0)
        {
            var npcs = gameState.World.Npcs?
                .Where(n => gameState.CurrentLocation.NpcIds.Contains(n.Id))
                .ToList();
            
            if (npcs?.Count > 0)
            {
                description += "\n\n= People here:\n";
                foreach (var npc in npcs)
                {
                    description += $"  * {npc.Name} - {npc.Description}\n";
                }
            }
        }

        // Add items info
        if (gameState.CurrentLocation.ItemIds?.Count > 0)
        {
            description += "\n\n= Items here:\n";
            foreach (var itemId in gameState.CurrentLocation.ItemIds)
            {
                description += $"  * {itemId}\n";
            }
        }

        return description;
    }

    private string GetWorldsDirectory()
    {
        return Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
            "source", "repos", "SoloAdventureSystem", "content", "worlds");
    }

    private IEnumerable<StoryNode> GetRoomStoryNodes()
    {
        var nodes = world?.StoryNodes ?? new List<StoryNode>();
        var currentNpcIds = gameState.CurrentLocation?.NpcIds ?? new List<string>();

        // Heuristics:
        // - Node id contains any npc id present in this room
        // - Node text mentions any npc name present in this room
        // - Node effects or skill checks reference opponent_npc_id matching npc ids
        var result = new List<StoryNode>();

        foreach (var n in nodes)
        {
            bool matched = false;

            // id contains npc id
            foreach (var nid in currentNpcIds)
            {
                if (!string.IsNullOrEmpty(n.Id) && n.Id.IndexOf(nid, StringComparison.OrdinalIgnoreCase) >= 0)
                {
                    matched = true; break;
                }
            }

            if (matched) { result.Add(n); continue; }

            // text mentions npc name
            if (n.Text != null && world?.Npcs != null)
            {
                foreach (var npcId in currentNpcIds)
                {
                    var npc = world.Npcs.FirstOrDefault(x => x.Id == npcId);
                    if (npc != null && !string.IsNullOrEmpty(npc.Name) && n.Text.IndexOf(npc.Name, StringComparison.OrdinalIgnoreCase) >= 0)
                    {
                        matched = true; break;
                    }
                }
            }

            if (matched) { result.Add(n); continue; }

            // choices reference opponent_npc_id or effects mention npc id
            if (n.Choices != null)
            {
                foreach (var c in n.Choices)
                {
                    if (c.SkillCheck != null && currentNpcIds.Contains(c.SkillCheck.OpponentNpcId)) { matched = true; break; }
                    if (c.Effects != null && c.Effects.Any(e => currentNpcIds.Any(id => e.IndexOf(id, StringComparison.OrdinalIgnoreCase) >= 0))) { matched = true; break; }
                }
            }

            if (matched) result.Add(n);
        }

        return result;
    }

    // Data models for loading
    private class WorldJsonModel
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Version { get; set; } = "";
        public string Author { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public string StartLocationId { get; set; } = "";
        public List<string> LocationIds { get; set; } = new();
        public List<string> NpcIds { get; set; } = new();
        public List<string> ItemIds { get; set; } = new();
        public List<string> FactionIds { get; set; } = new();
        public List<string> StoryNodeIds { get; set; } = new();
    }

    private class RoomModel
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public string BaseDescription { get; set; } = "";
        public Dictionary<string, string>? Exits { get; set; }
        public List<string>? Npcs { get; set; }
        public List<string>? Items { get; set; }
    }

    private class NpcModel
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string FactionId { get; set; } = "";
        public string Hostility { get; set; } = "Neutral";
        public string Behavior { get; set; } = "Static";
        public List<string> Inventory { get; set; } = new();
        public NpcAttributes Attributes { get; set; } = new();
    }

    private class NpcAttributes
    {
        public int Strength { get; set; } = 10;
        public int Dexterity { get; set; } = 10;
        public int Intelligence { get; set; } = 10;
        public int Constitution { get; set; } = 10;
        public int Wisdom { get; set; } = 10;
        public int Charisma { get; set; } = 10;
    }

    private class FactionModel
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Ideology { get; set; } = "";
        public Dictionary<string, int> Relations { get; set; } = new();
    }
}
@page "/game/{seed}"
@rendermode InteractiveServer
@using System.IO
@using System.IO.Compression
@using System.Text.Json
@using SoloAdventureSystem.Engine.Models
@using SoloAdventureSystem.Engine.Game
@using SoloAdventureSystem.Engine.WorldLoader
@using SoloAdventureSystem.Engine.Rules
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Playing @world?.WorldDefinition?.Name ?? "Game"</PageTitle>

<link rel="stylesheet" href="/css/shared-pages.css" />

<div class="mud-home">
    <div class="mud-container">
        @if (isLoading)
        {
            <Card>
                <div class="card-content" style="text-align: center;">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    <p style="color: var(--color-text-muted);">Loading game...</p>
                </div>
            </Card>
        }
        else if (world == null)
        {
            <Card>
                <div class="card-content" style="text-align: center;">
                    <div class="error-icon"></div>
                    <h3 style="color: var(--color-text-primary); margin-bottom: 1rem;">World Not Found</h3>
                    <p style="color: var(--color-text-secondary); margin-bottom: 2rem;">
                        The world you're trying to play doesn't exist or has been deleted.
                    </p>
                    <a href="/worlds" class="custom-button btn-neutral" style="text-decoration: none;">
                        Back to Worlds
                    </a>
                </div>
            </Card>
        }
        else
        {
            <div class="page-header">
                <div class="page-header-left">
                    <a href="/worlds" style="color: var(--color-text-muted); text-decoration: none; font-size: var(--font-size-sm);">&larr; Back to Worlds</a>
                    <h1 style="color: var(--color-text-primary); margin: 0.5rem 0;">Playing @world.WorldDefinition.Name</h1>
                    <p style="color: var(--color-text-secondary); margin: 0;">Turn: @gameState.TurnCount | HP: @gameState.Player.HP/@gameState.Player.MaxHP</p>
                </div>
                <div class="page-header-actions">
                    <Button Appearance="neutral" OnClick="ShowStats">Stats</Button>
                    <Button Appearance="neutral" OnClick="ShowInventory">Inventory</Button>
                    <Button Appearance="danger" OnClick="QuitGame">Quit</Button>
                </div>
            </div>

            <div class="game-grid">
                <div>
                    <Card>
                        <div class="card-content">
                            <h3 style="color: var(--color-accent-primary); margin-bottom: 1rem;">@gameState.CurrentLocation.Name</h3>
                            <p style="color: var(--color-text-secondary); line-height: 1.6; white-space: pre-wrap;">@GetLocationDescription()</p>
                        </div>
                    </Card>

                    <Card>
                        <div class="card-content">
                            <h4 style="color: var(--color-accent-primary); margin-bottom: 1rem;">Available Actions</h4>
                            <div class="action-list">
                                @foreach (var action in availableActions)
                                {
                                    <Button Appearance="accent" OnClick="() => ExecuteAction(action)" Class="action-button-fullwidth">@action</Button>
                                }
                            </div>
                        </div>
                    </Card>
                </div>

                <div class="sidebar">
                    <Card>
                        <div class="card-content">
                            <h4 style="color: var(--color-accent-primary); margin-bottom: 1rem;">Quick Actions</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                <Button Appearance="neutral" OnClick="LookAround" Class="action-button-fullwidth">Look Around</Button>
                            </div>
                        </div>
                    </Card>

                    <Card>
                        <div class="card-content">
                            <h4 style="color: var(--color-accent-primary); margin-bottom: 1rem;">Player</h4>
                            <div style="display: grid; gap: 0.5rem;">
                                <div><strong>Name:</strong> @gameState.Player.Name</div>
                                <div><strong>HP:</strong> @gameState.Player.HP/@gameState.Player.MaxHP</div>
                                <div><strong>Items:</strong> @gameState.Inventory.Count</div>
                                <div><strong>Quests:</strong> @gameState.Player.ActiveQuests.Count</div>
                            </div>
                        </div>
                    </Card>
                </div>
            </div>

            @if (world?.StoryNodes != null)
            {
                var roomNodes = GetRoomStoryNodes().ToList();
                <Card>
                    <div class="card-content dialogue-list">
                        <h5 style="color: var(--color-text-primary); margin: 0 0 0.5rem 0;">Dialogue Index (Debug) - This Room</h5>
                        @if (roomNodes.Count == 0)
                        {
                            <div style="color: var(--color-text-muted);">No story nodes attached to this room.</div>
                        }
                        else
                        {
                            @foreach (var sn in roomNodes)
                            {
                                <div style="padding: 0.5rem; border-bottom: 1px solid var(--color-border-default);">
                                    <div><strong>ID:</strong> @sn.Id</div>
                                    <div><strong>Title:</strong> @sn.Title</div>
                                    <div style="margin-top: 0.25rem;"><strong>Choices:</strong></div>
                                    @if (sn.Choices != null && sn.Choices.Count > 0)
                                    {
                                        <ul style="margin:0 0 0.5rem 1rem; padding:0; color: var(--color-text-secondary);">
                                            @foreach (var c in sn.Choices)
                                            {
                                                <li>@c.Label <span style="color: var(--color-text-muted);">? @c.Next</span></li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <div style="color: var(--color-text-muted);">(no choices)</div>
                                    }
                                </div>
                            }
                        }
                    </div>
                </Card>
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public string Seed { get; set; } = "";
    
    private WorldModel? world;
    private GameState gameState = new();
    private bool isLoading = true;
    private List<string> availableActions = new();
    private bool showStatsModal = false;
    private bool showInventoryModal = false;
    private string message = "";

    // Dialogue state
    private bool showDialogueModal = false;
    private StoryNode? currentStoryNode;
    private string dialogueOutcome = "";

    private string? _lastLoadedSeed;
    private bool _isLoadingInProgress = false;

    protected override void OnInitialized()
    {
        // Subscribe to location changes so client-side navigation triggers loading reliably
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        // If seed changed (or first set), load world for the new seed
        if (!string.Equals(_lastLoadedSeed, Seed, StringComparison.OrdinalIgnoreCase))
        {
            _lastLoadedSeed = Seed;
            await EnsureLoadWorldForSeed(Seed);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        try
        {
            var uri = new Uri(e.Location);
            var segments = uri.AbsolutePath.Trim('/').Split('/');
            if (segments.Length >= 2 && string.Equals(segments[0], "game", StringComparison.OrdinalIgnoreCase))
            {
                var newSeed = segments[1];
                if (!string.Equals(_lastLoadedSeed, newSeed, StringComparison.OrdinalIgnoreCase))
                {
                    _lastLoadedSeed = newSeed;
                    await EnsureLoadWorldForSeed(newSeed);
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch { }
    }

    private async Task EnsureLoadWorldForSeed(string seed)
    {
        if (_isLoadingInProgress) return;
        _isLoadingInProgress = true;
        try
        {
            await LoadWorld(seed);
            if (world != null)
            {
                InitializeGame();
            }

            // Ensure UI updates after load and initialization
            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            _isLoadingInProgress = false;
        }
    }

    private async Task LoadWorld(string seed)
    {
        isLoading = true;
        world = null;
        await InvokeAsync(StateHasChanged);

        try
        {
            var worldsPath = GetWorldsDirectory();
            if (!Directory.Exists(worldsPath)) return;

            var files = Directory.GetFiles(worldsPath, "*.zip");

            // Try to match by file name (without extension) first, then fallback to pattern
            string? match = files.FirstOrDefault(f => Path.GetFileNameWithoutExtension(f).Equals(seed, StringComparison.OrdinalIgnoreCase));

            if (match == null)
            {
                // Fallback: if Seed looks like a timestamp suffix, try wildcard
                match = files.FirstOrDefault(f => Path.GetFileName(f).Equals(seed + ".zip", StringComparison.OrdinalIgnoreCase) || Path.GetFileName(f).Contains(seed));
            }

            if (match != null)
            {
                using var zip = ZipFile.OpenRead(match);

                // Read world.json for metadata
                var worldEntry = zip.GetEntry("world.json");
                if (worldEntry != null)
                {
                    using var stream = worldEntry.Open();
                    using var reader = new StreamReader(stream);
                    var json = await reader.ReadToEndAsync();

                    var worldMetadata = JsonSerializer.Deserialize<WorldJsonModel>(json, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });

                    if (worldMetadata != null)
                    {
                        world = new WorldModel
                        {
                            WorldDefinition = new WorldDefinition(
                                worldMetadata.Name,
                                worldMetadata.Description,
                                worldMetadata.Version,
                                worldMetadata.Author,
                                worldMetadata.CreatedAt,
                                worldMetadata.StartLocationId,
                                worldMetadata.LocationIds,
                                worldMetadata.NpcIds,
                                worldMetadata.ItemIds,
                                worldMetadata.FactionIds,
                                worldMetadata.StoryNodeIds
                            ),
                            Rooms = new List<Location>(),
                            Npcs = new List<NPC>(),
                            Factions = new List<Faction>(),
                            Events = new List<EventModel>(),
                            StoryNodes = new List<StoryNode>()
                        };
                    }
                }

                if (world == null) return;

                // Read rooms, npcs, factions, story nodes as before
                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("rooms/") && e.FullName.EndsWith(".json")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var roomJson = await reader.ReadToEndAsync();
                    var room = JsonSerializer.Deserialize<RoomModel>(roomJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    if (room != null)
                    {
                        world.Rooms.Add(new Location(
                            room.Id,
                            room.Title,
                            room.BaseDescription,
                            room.Exits ?? new Dictionary<string, string>(),
                            room.Npcs ?? new List<string>(),
                            room.Items ?? new List<string>()
                        ));
                    }
                }

                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("npcs/") && e.FullName.EndsWith(".json")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var npcJson = await reader.ReadToEndAsync();
                    var npc = JsonSerializer.Deserialize<NpcModel>(npcJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    if (npc != null)
                    {
                        world.Npcs.Add(new NPC(
                            npc.Id,
                            npc.Name,
                            npc.Description,
                            npc.FactionId,
                            Enum.Parse<Hostility>(npc.Hostility, true),
                            new Attributes(
                                npc.Attributes.Strength,
                                npc.Attributes.Dexterity,
                                npc.Attributes.Intelligence,
                                npc.Attributes.Constitution,
                                npc.Attributes.Wisdom,
                                npc.Attributes.Charisma
                            ),
                            Enum.Parse<Behavior>(npc.Behavior, true),
                            npc.Inventory
                        ));
                    }
                }

                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("factions/") && e.FullName.EndsWith(".json")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var factionJson = await reader.ReadToEndAsync();
                    var faction = JsonSerializer.Deserialize<FactionModel>(factionJson, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    if (faction != null)
                    {
                        world.Factions.Add(new Faction(
                            faction.Id,
                            faction.Name,
                            faction.Description,
                            faction.Ideology,
                            faction.Relations ?? new Dictionary<string, int>()
                        ));
                    }
                }

                foreach (var entry in zip.Entries.Where(e => e.FullName.StartsWith("story/") && e.FullName.EndsWith(".yaml")))
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var yaml = await reader.ReadToEndAsync();
                    try
                    {
                        try
                        {
                            var deserializer = new YamlDotNet.Serialization.DeserializerBuilder()
                                .IgnoreUnmatchedProperties()
                                .Build();

                            var genNode = deserializer.Deserialize<SoloAdventureSystem.ContentGenerator.Models.StoryNodeModel>(yaml);
                            if (genNode != null)
                            {
                                var engineNode = new StoryNode
                                {
                                    Id = genNode.Id ?? string.Empty,
                                    Title = genNode.Title ?? string.Empty,
                                    Text = genNode.Text ?? string.Empty,
                                    Choices = new List<StoryChoice>()
                                };

                                if (genNode.Choices != null)
                                {
                                    foreach (var gc in genNode.Choices)
                                    {
                                        var sc = gc.SkillCheck != null ? new SkillCheck
                                        {
                                            Attribute = gc.SkillCheck.Attribute,
                                            Skill = gc.SkillCheck.Skill,
                                            TargetNumber = gc.SkillCheck.TargetNumber,
                                            OpponentNpcId = gc.SkillCheck.OpponentNpcId ?? string.Empty
                                        } : null;

                                        var choice = new StoryChoice
                                        {
                                            Label = gc.Label ?? string.Empty,
                                            Next = gc.Next ?? string.Empty,
                                            Effects = gc.Effects ?? new List<string>(),
                                            SkillCheck = sc
                                        };

                                        engineNode.Choices.Add(choice);
                                    }
                                }

                                world.StoryNodes.Add(engineNode);
                                continue;
                            }
                        }
                        catch (Exception) { }

                        var loader = new WorldLoaderService();
                        var node = loader.ParseStoryNode(yaml);
                        if (node != null) world.StoryNodes.Add(node);
                    }
                    catch { }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading world: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            // ensure UI updates after load completes
            await InvokeAsync(StateHasChanged);
        }
    }

    private void InitializeGame()
    {
        if (world?.WorldDefinition == null) return;

        gameState.World = world;
        var startLocation = world.Rooms?.FirstOrDefault(l => l.Id == world.WorldDefinition.StartLocationId);
        if (startLocation != null)
        {
            gameState.CurrentLocation = startLocation;
        }
        gameState.Player = new PlayerCharacter();
        gameState.TurnCount = 0;

        UpdateAvailableActions();
    }

    private void UpdateAvailableActions()
    {
        availableActions.Clear();

        // Movement options
        if (gameState.CurrentLocation.Connections?.Count > 0)
        {
            foreach (var connection in gameState.CurrentLocation.Connections)
            {
                availableActions.Add($"Go {connection.Key}");
            }
        }

        // Interaction options
        if (gameState.CurrentLocation.NpcIds?.Count > 0)
        {
            var npcs = gameState.World.Npcs?
                .Where(n => gameState.CurrentLocation.NpcIds.Contains(n.Id))
                .ToList();
            
            if (npcs?.Count > 0)
            {
                foreach (var npc in npcs)
                {
                    availableActions.Add($"Talk to {npc.Name}");
                    if (npc.Hostility == Hostility.Hostile)
                    {
                        availableActions.Add($"Attack {npc.Name}");
                    }
                }
            }
        }

        // Item options
        if (gameState.CurrentLocation.ItemIds?.Count > 0)
        {
            foreach (var itemId in gameState.CurrentLocation.ItemIds)
            {
                availableActions.Add($"Take {itemId}");
            }
        }

        // Inventory use options
        if (gameState.Inventory.Count > 0)
        {
            foreach (var itemId in gameState.Inventory)
            {
                availableActions.Add($"Use {itemId}");
            }
        }

        StateHasChanged();
    }

    private void ExecuteAction(string action)
    {
        gameState.TurnCount++;

        if (action.StartsWith("Go "))
        {
            var direction = action.Substring(3);
            MoveToLocation(direction);
        }
        else if (action.StartsWith("Talk to "))
        {
            var npcName = action.Substring(8);
            TalkToNPC(npcName);
        }
        else if (action.StartsWith("Attack "))
        {
            var npcName = action.Substring(7);
            AttackNPC(npcName);
        }
        else if (action.StartsWith("Take "))
        {
            var itemName = action.Substring(5);
            TakeItem(itemName);
        }
        else if (action.StartsWith("Use "))
        {
            var itemName = action.Substring(4);
            UseItem(itemName);
        }

        UpdateAvailableActions();
    }

    private void MoveToLocation(string direction)
    {
        if (gameState.CurrentLocation.Connections?.TryGetValue(direction, out var locationId) == true)
        {
            var newLocation = gameState.World.Rooms?.FirstOrDefault(l => l.Id == locationId);
            if (newLocation != null)
            {
                gameState.CurrentLocation = newLocation;
                ShowMessage($"You travel {direction}.");
            }
        }
    }

    private void TalkToNPC(string npcName)
    {
        var npc = gameState.World.Npcs?.FirstOrDefault(n => 
            n.Name == npcName && gameState.CurrentLocation.NpcIds?.Contains(n.Id) == true);
        
        if (npc != null)
        {
            // Try to find a pre-generated story node for dialogue using several heuristics
            var nodes = gameState.World.StoryNodes ?? new List<StoryNode>();

            StoryNode? node = null;

            // 1) Exact generator convention: dialogue_{npcId}_*
            node = nodes.FirstOrDefault(s => s.Id.StartsWith($"dialogue_{npc.Id}_", StringComparison.OrdinalIgnoreCase));

            // 2) ID contains npc id (fallback)
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Id.IndexOf(npc.Id, StringComparison.OrdinalIgnoreCase) >= 0);

            // 3) Text mentions NPC name
            if (node == null)
                node = nodes.FirstOrDefault(s => !string.IsNullOrEmpty(s.Text) && s.Text.IndexOf(npc.Name ?? "", StringComparison.OrdinalIgnoreCase) >= 0);

            // 4) Skill checks reference opponent npc id
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Choices != null && s.Choices.Any(c => c.SkillCheck != null && string.Equals(c.SkillCheck.OpponentNpcId, npc.Id, StringComparison.OrdinalIgnoreCase)));

            // 5) Effects reference the npc id or daemon tag
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Choices != null && s.Choices.Any(c => c.Effects != null && c.Effects.Any(e => e.IndexOf(npc.Id, StringComparison.OrdinalIgnoreCase) >= 0 || e.IndexOf($"Daemon:{npc.Id}", StringComparison.OrdinalIgnoreCase) >= 0)));

            // 6) Last resort: any dialogue_ node at this location
            if (node == null)
                node = nodes.FirstOrDefault(s => s.Id.StartsWith("dialogue_") );

            if (node != null)
            {
                currentStoryNode = node;
                dialogueOutcome = string.Empty;
                showDialogueModal = true;
                StateHasChanged();
                return;
            }
            
            // Fallback: show basic description and log that no dialogue node was found for this NPC
            try
            {
                Console.WriteLine($"No story node found for NPC {npc.Id} ({npc.Name}) in this world. Available story nodes: {gameState.World.StoryNodes?.Count ?? 0}");
            }
            catch { /* swallow logging errors in UI */ }

            var description = npc.Description ?? "They have nothing to say.";
            var name = npc.Name ?? "Someone";
            var message = $"\"{description}\"\n\n- {name}";
            ShowMessage(message);
         }
     }

    private void OnDialogueChoiceSelected(StoryChoice choice)
    {
        dialogueOutcome = string.Empty;

        // If there's a skill check, resolve it
        if (choice.SkillCheck != null)
        {
            var sc = choice.SkillCheck;

            var playerAttributes = gameState.Player.Attributes;
            var playerSkills = gameState.Player.Skills;
            var playerDaemon = gameState.GetDaemonFor("player");

            var outcome = DaemonDialogue.ResolveSkillCheck(playerAttributes, playerSkills, playerDaemon,
                sc.Attribute, sc.Skill, sc.TargetNumber);

            // Build detailed roll info
            var diceStr = outcome.Roll.Dice != null && outcome.Roll.Dice.Count > 0
                ? string.Join(", ", outcome.Roll.Dice)
                : "";

            // daemon modifier (for display) - safe default
            var daemonMod = playerDaemon?.GetSkillModifier(sc.Skill) ?? 0;

            var baseTotal = outcome.Roll.Total;
            var modifiedTotal = outcome.ModifiedTotal;

            var critNote = outcome.CriticalSuccess ? " (Critical Success)" : outcome.CriticalFailure ? " (Critical Failure)" : string.Empty;

            dialogueOutcome = $"Roll: [{diceStr}] -> base {baseTotal}; Daemon mod: {daemonMod}; Modified: {modifiedTotal} vs Target: {sc.TargetNumber}{critNote}";

            if (outcome.Success)
            {
                dialogueOutcome = "Success! " + dialogueOutcome;
                // Apply effects
                foreach (var eff in choice.Effects ?? new List<string>())
                {
                    DaemonDialogue.ApplyEffect(gameState, eff);
                }

                // Navigate to Next node
                NavigateToStoryNode(choice.Next);
                return;
            }
            else
            {
                dialogueOutcome = "Failure. " + dialogueOutcome;
                // apply failure effect if any
                foreach (var eff in choice.Effects ?? new List<string>())
                {
                    // Optionally apply negative or partial effects - for now apply same
                    DaemonDialogue.ApplyEffect(gameState, eff);
                }

                // Navigate to a hostile or fallback node if exists
                var hostile = gameState.World.StoryNodes?.FirstOrDefault(s => s.Id.Contains("hostile") || s.Id.Contains("dialogue_hostile"));
                if (hostile != null)
                {
                    currentStoryNode = hostile;
                    StateHasChanged();
                    return;
                }
                else
                {
                    NavigateToStoryNode(choice.Next);
                    return;
                }
            }
        }
        else
        {
            // No skill check, apply effects and navigate
            foreach (var eff in choice.Effects ?? new List<string>())
            {
                DaemonDialogue.ApplyEffect(gameState, eff);
            }
            NavigateToStoryNode(choice.Next);
            return;
        }
    }

    private void NavigateToStoryNode(string nextId)
    {
        if (string.IsNullOrEmpty(nextId) || nextId == "end")
        {
            // close dialogue
            showDialogueModal = false;
            currentStoryNode = null;
            StateHasChanged();
            return;
        }

        var next = gameState.World.StoryNodes?.FirstOrDefault(s => s.Id == nextId);
        if (next != null)
        {
            currentStoryNode = next;
        }
        else
        {
            // missing node -> close
            showDialogueModal = false;
            currentStoryNode = null;
        }

        StateHasChanged();
    }

    private void AttackNPC(string npcName)
    {
        var npc = gameState.World.Npcs?.FirstOrDefault(n => 
            n.Name == npcName && gameState.CurrentLocation.NpcIds?.Contains(n.Id) == true);
        
        if (npc != null)
        {
            var playerStats = gameState.Player.ToCharacterStats();
            var npcAttributes = new Dictionary<GameAttribute, int>
            {
                [GameAttribute.Body] = npc.Attributes.Strength,
                [GameAttribute.Mind] = npc.Attributes.Intelligence,
                [GameAttribute.Soul] = npc.Attributes.Wisdom,
                [GameAttribute.Presence] = npc.Attributes.Charisma
            };
            var npcSkills = new Dictionary<Skill, int>
            {
                [Skill.Combat] = 0,
                [Skill.Stealth] = 0,
                [Skill.Knowledge] = 0,
                [Skill.Awareness] = 0,
                [Skill.Social] = 0,
                [Skill.Will] = 0,
                [Skill.Occult] = 0
            };
            var npcStats = new CharacterStats(npcAttributes, npcSkills, 10, 6);

            var attackResult = RuleEngine.RollCombatAttack(playerStats, npcStats);
            
            if (attackResult.Hit)
            {
                var damageResult = RuleEngine.RollDamage(DamageType.Unarmed);
                ShowMessage($"You hit {npcName} for {damageResult.Damage} damage!\n\nThe {npcName} is defeated.");
                gameState.CurrentLocation.NpcIds?.Remove(npc.Id);
            }
            else
            {
                ShowMessage($"You miss {npcName}.");
            }
        }
    }

    private void TakeItem(string itemName)
    {
        if (gameState.CurrentLocation.ItemIds?.Contains(itemName) == true)
        {
            gameState.Inventory.Add(itemName);
            gameState.CurrentLocation.ItemIds?.Remove(itemName);
            ShowMessage($"You take the {itemName}.");
        }
    }

    private void UseItem(string itemName)
    {
        if (gameState.Inventory.Contains(itemName))
        {
            ShowMessage($"You use the {itemName}.");
        }
    }

    private void LookAround()
    {
        var locationName = gameState.CurrentLocation.Name ?? "Unknown Location";
        var description = gameState.CurrentLocation.Description ?? "You see nothing of interest.";
        ShowMessage($"You look around {locationName}.\n\n{description}");
    }

    private void ShowStats()
    {
        showStatsModal = true;
        StateHasChanged();
    }

    private void CloseStatsModal()
    {
        showStatsModal = false;
        StateHasChanged();
    }

    private void ShowInventory()
    {
        showInventoryModal = true;
        StateHasChanged();
    }

    private void CloseInventoryModal()
    {
        showInventoryModal = false;
        StateHasChanged();
    }

    private void CloseDialogue()
    {
        showDialogueModal = false;
        currentStoryNode = null;
        dialogueOutcome = string.Empty;
        StateHasChanged();
    }

    private void ShowMessage(string msg)
    {
        message = msg;
        StateHasChanged();
    }

    private void CloseMessage()
    {
        message = "";
        StateHasChanged();
    }

    private void QuitGame()
    {
        Navigation.NavigateTo("/worlds");
    }

    private string GetLocationDescription()
    {
        var description = gameState.CurrentLocation.Description;
        
        // Add NPCs info
        if (gameState.CurrentLocation.NpcIds?.Count > 0)
        {
            var npcs = gameState.World.Npcs?
                .Where(n => gameState.CurrentLocation.NpcIds.Contains(n.Id))
                .ToList();
            
            if (npcs?.Count > 0)
            {
                description += "\n\n= People here:\n";
                foreach (var npc in npcs)
                {
                    description += $"  * {npc.Name} - {npc.Description}\n";
                }
            }
        }

        // Add items info
        if (gameState.CurrentLocation.ItemIds?.Count > 0)
        {
            description += "\n\n= Items here:\n";
            foreach (var itemId in gameState.CurrentLocation.ItemIds)
            {
                description += $"  * {itemId}\n";
            }
        }

        return description;
    }

    private string GetWorldsDirectory()
    {
        return Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
            "source", "repos", "SoloAdventureSystem", "content", "worlds");
    }

    public void Dispose()
    {
        try { Navigation.LocationChanged -= OnLocationChanged; } catch { }
    }

    private IEnumerable<StoryNode> GetRoomStoryNodes()
    {
        var nodes = world?.StoryNodes ?? new List<StoryNode>();
        var currentNpcIds = gameState.CurrentLocation?.NpcIds ?? new List<string>();

        // Heuristics:
        // - Node id contains any npc id present in this room
        // - Node text mentions any npc name present in this room
        // - Node effects or skill checks reference opponent_npc_id matching npc ids
        var result = new List<StoryNode>();

        foreach (var n in nodes)
        {
            bool matched = false;

            // id contains npc id
            foreach (var nid in currentNpcIds)
            {
                if (!string.IsNullOrEmpty(n.Id) && n.Id.IndexOf(nid, StringComparison.OrdinalIgnoreCase) >= 0)
                {
                    matched = true; break;
                }
            }

            if (matched) { result.Add(n); continue; }

            // text mentions npc name
            if (n.Text != null && world?.Npcs != null)
            {
                foreach (var npcId in currentNpcIds)
                {
                    var npc = world.Npcs.FirstOrDefault(x => x.Id == npcId);
                    if (npc != null && !string.IsNullOrEmpty(npc.Name) && n.Text.IndexOf(npc.Name, StringComparison.OrdinalIgnoreCase) >= 0)
                    {
                        matched = true; break;
                    }
                }
            }

            if (matched) { result.Add(n); continue; }

            // choices reference opponent_npc_id or effects mention npc id
            if (n.Choices != null)
            {
                foreach (var c in n.Choices)
                {
                    if (c.SkillCheck != null && currentNpcIds.Contains(c.SkillCheck.OpponentNpcId)) { matched = true; break; }
                    if (c.Effects != null && c.Effects.Any(e => currentNpcIds.Any(id => e.IndexOf(id, StringComparison.OrdinalIgnoreCase) >= 0))) { matched = true; break; }
                }
            }

            if (matched) result.Add(n);
        }

        return result;
    }

    // Data models for loading
    private class WorldJsonModel
    {
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Version { get; set; } = "";
        public string Author { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public string StartLocationId { get; set; } = "";
        public List<string> LocationIds { get; set; } = new();
        public List<string> NpcIds { get; set; } = new();
        public List<string> ItemIds { get; set; } = new();
        public List<string> FactionIds { get; set; } = new();
        public List<string> StoryNodeIds { get; set; } = new();
    }

    private class RoomModel
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public string BaseDescription { get; set; } = "";
        public Dictionary<string, string>? Exits { get; set; }
        public List<string>? Npcs { get; set; }
        public List<string>? Items { get; set; }
    }

    private class NpcModel
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string FactionId { get; set; } = "";
        public string Hostility { get; set; } = "Neutral";
        public string Behavior { get; set; } = "Static";
        public List<string> Inventory { get; set; } = new();
        public NpcAttributes Attributes { get; set; } = new();
    }

    private class NpcAttributes
    {
        public int Strength { get; set; } = 10;
        public int Dexterity { get; set; } = 10;
        public int Intelligence { get; set; } = 10;
        public int Constitution { get; set; } = 10;
        public int Wisdom { get; set; } = 10;
        public int Charisma { get; set; } = 10;
    }

    private class FactionModel
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string Ideology { get; set; } = "";
        public Dictionary<string, int> Relations { get; set; } = new();
    }
}
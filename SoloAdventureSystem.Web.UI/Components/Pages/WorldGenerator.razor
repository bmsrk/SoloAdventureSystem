@page "/generate"
@rendermode InteractiveServer
@using SoloAdventureSystem.ContentGenerator
@using SoloAdventureSystem.ContentGenerator.Models
@using SoloAdventureSystem.ContentGenerator.Configuration
@using SoloAdventureSystem.ContentGenerator.EmbeddedModel
@using SoloAdventureSystem.Web.UI.Services
@using SoloAdventureSystem.ContentGenerator.Generation
@using Microsoft.Extensions.Options
@inject WorldGenerationService GenerationService
@inject IOptions<AISettings> AISettings
@inject ILogger<WorldGenerator> Logger

<PageTitle>AI World Generator</PageTitle>

<div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1 class="display-4" style="font-weight: 700; color: white;">AI World Generator</h1>
        <p class="lead" style="color: #c8c8c8;">Generate procedural game worlds using local LLM models</p>
    </div>

    @if (!GenerationService.IsInitialized)
    {
        <FluentCard style="margin-bottom: 2rem;">
            <div style="padding: 1.5rem;">
                <h4 style="color: white; margin-bottom: 1rem;">Select AI Model</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- TinyLlama -->
                    <div class="model-card @(selectedModel == "tinyllama-q4" ? "selected" : "")" 
                         @onclick='() => SelectModel("tinyllama-q4")'>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h5 style="color: white;">TinyLlama</h5>
                            <span class="model-badge badge-speed-fast">FASTEST</span>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">SIZE</div>
                            <div class="h4" style="color: white;">~700 MB</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">DOWNLOAD</div>
                            <div style="color: white;">2-5 minutes</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">SPEED</div>
                            <div style="color: white;">30-45 seconds</div>
                        </div>
                        <span class="model-badge badge-quality-good">Good Quality</span>
                    </div>

                    <!-- Llama-3.2 -->
                    <div class="model-card @(selectedModel == "llama-3.2-1b-q4" ? "selected" : "")" 
                         @onclick='() => SelectModel("llama-3.2-1b-q4")'>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h5 style="color: white;">Llama 3.2</h5>
                            <span class="model-badge badge-speed-medium">BALANCED</span>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">SIZE</div>
                            <div class="h4" style="color: white;">~2 GB</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">DOWNLOAD</div>
                            <div style="color: white;">4-8 minutes</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">SPEED</div>
                            <div style="color: white;">1-2 minutes</div>
                        </div>
                        <span class="model-badge badge-quality-best">Excellent</span>
                    </div>

                    <!-- Phi-3 Mini -->
                    <div class="model-card @(selectedModel == "phi-3-mini-q4" ? "selected" : "")" 
                         @onclick='() => SelectModel("phi-3-mini-q4")'>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h5 style="color: white;">Phi-3 Mini</h5>
                            <span class="model-badge badge-quality-best">BEST</span>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">SIZE</div>
                            <div class="h4" style="color: white;">~2.3 GB</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">DOWNLOAD</div>
                            <div style="color: white;">5-10 minutes</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: #9ca3af;">SPEED</div>
                            <div style="color: white;">1-2 minutes</div>
                        </div>
                        <span class="model-badge badge-quality-best">Best Quality</span>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <FluentButton Appearance="Appearance.Accent" 
                                  @onclick="InitializeAI" 
                                  Disabled="@(isInitializing || string.IsNullOrEmpty(selectedModel))"
                                  Style="padding: 12px 32px;">
                        @if (isInitializing)
                        {
                            <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 8px;" />
                            <span>Initializing...</span>
                        }
                        else
                        {
                            <span>Initialize @selectedModel</span>
                        }
                    </FluentButton>
                </div>

                @if (!string.IsNullOrEmpty(initProgress))
                {
                    <div class="message-bar message-bar-info">
                        <div class="message-icon">??</div>
                        <div class="message-content">
                            <strong>Progress:</strong> <span>@initProgress</span>
                        </div>
                    </div>
                }

                <div class="message-bar message-bar-info">
                    <div class="message-icon">??</div>
                    <div class="message-content">
                        <strong>GPU Acceleration:</strong>
                        <FluentBadge Appearance="@(AISettings.Value.UseGPU ? Appearance.Accent : Appearance.Neutral)" Style="margin-left: 8px;">
                            @(AISettings.Value.UseGPU ? "ENABLED" : "DISABLED")
                        </FluentBadge>
                        @if (AISettings.Value.UseGPU)
                        {
                            <div class="small" style="margin-top: 8px;">Using CUDA for faster generation</div>
                        }
                    </div>
                </div>
            </div>
        </FluentCard>
    }
    else
    {
        <FluentCard style="margin-bottom: 2rem;">
            <div style="padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h4 style="color: white; margin: 0;">World Configuration</h4>
                    <div>
                        <FluentBadge Appearance="Appearance.Accent" Style="margin-right: 8px;">AI READY</FluentBadge>
                        <FluentBadge Appearance="Appearance.Neutral">@selectedModel</FluentBadge>
                    </div>
                </div>

                <EditForm Model="@options" OnValidSubmit="@GenerateWorld">
                    <h6 style="color: white; margin-bottom: 1rem;">Basic Settings</h6>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <FluentTextField Label="World Name" @bind-Value="options.Name" Style="width: 100%;" />
                        <FluentNumberField Label="Random Seed" @bind-Value="options.Seed" Style="width: 100%;" />
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                        <FluentTextField Label="Theme" @bind-Value="options.Theme" Style="width: 100%;" />
                        <FluentNumberField Label="Regions" @bind-Value="options.Regions" Min="3" Max="20" Style="width: 100%;" />
                    </div>

                    <h6 style="color: white; margin-bottom: 1rem;">Advanced Settings</h6>

                    <div style="margin-bottom: 1rem;">
                        <FluentTextField Label="Flavor/Mood" @bind-Value="options.Flavor" Style="width: 100%;" />
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <FluentTextArea Label="Setting Description" @bind-Value="options.Description" Rows="2" Style="width: 100%;" />
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <FluentTextField Label="Main Plot Point" @bind-Value="options.MainPlotPoint" Style="width: 100%;" />
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <FluentTextField Label="Time Period" @bind-Value="options.TimePeriod" Style="width: 100%;" />
                        <FluentTextField Label="Power Structure" @bind-Value="options.PowerStructure" Style="width: 100%;" />
                    </div>

                    <FluentButton Appearance="Appearance.Accent" 
                                  Type="ButtonType.Submit" 
                                  Disabled="@isGenerating"
                                  Style="width: 100%; padding: 14px;">
                        @if (isGenerating)
                        {
                            <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 8px;" />
                            <span>Generating...</span>
                        }
                        else
                        {
                            <span>Generate World</span>
                        }
                    </FluentButton>
                </EditForm>

                @if (!string.IsNullOrEmpty(generationProgress))
                {
                    <div style="margin-top: 1.5rem;">
                        <FluentProgress Value="@progressPercentage" Max="100" Style="width: 100%; margin-bottom: 1rem;" />
                        <div style="color: white;"><strong>Status:</strong> @generationProgress</div>
                    </div>
                }
            </div>
        </FluentCard>

        @if (generatedWorld != null)
        {
            <FluentCard style="margin-bottom: 2rem;">
                <div style="padding: 1.5rem;">
                    <h4 style="color: white; margin-bottom: 1.5rem;">Generation Complete</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2rem; text-align: center; margin-bottom: 1.5rem;">
                        <div>
                            <div class="stat-value">@generatedWorld.Rooms.Count</div>
                            <div class="text-muted">Rooms</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.Npcs.Count</div>
                            <div class="text-muted">NPCs</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.Factions.Count</div>
                            <div class="text-muted">Factions</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.LoreEntries.Count</div>
                            <div class="text-muted">Lore</div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(exportPath))
                    {
                        <div class="message-bar message-bar-success">
                            <div class="message-icon">?</div>
                            <div class="message-content">
                                <h6 style="margin: 0 0 0.5rem 0;">Exported Successfully</h6>
                                <code style="background: #0a0a0a; padding: 4px 8px; border-radius: 4px; display: block; margin-bottom: 0.5rem;">@exportPath</code>
                                <div class="small">@FormatFileSize(new FileInfo(exportPath).Length)</div>
                            </div>
                        </div>
                    }
                </div>
            </FluentCard>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                <FluentCard>
                    <div style="padding: 1.5rem;">
                        <h5 style="color: white; margin-bottom: 1rem;">First Room</h5>
                        <div class="preview-card">
                            <h6>@generatedWorld.Rooms[0].Title</h6>
                            <p>@generatedWorld.Rooms[0].BaseDescription</p>
                        </div>
                    </div>
                </FluentCard>

                @if (generatedWorld.Npcs.Count > 0)
                {
                    <FluentCard>
                        <div style="padding: 1.5rem;">
                            <h5 style="color: white; margin-bottom: 1rem;">First NPC</h5>
                            <div class="preview-card">
                                <h6>@generatedWorld.Npcs[0].Name</h6>
                                <p>@generatedWorld.Npcs[0].Description</p>
                            </div>
                        </div>
                    </FluentCard>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="message-bar message-bar-error">
                <div class="message-icon">??</div>
                <div class="message-content">
                    <h5 style="margin: 0 0 0.5rem 0;">Error</h5>
                    <p style="margin: 0;">@errorMessage</p>
                </div>
            </div>
        }
    }
</div>

@code {
    private WorldGenerationOptions options = new()
    {
        Name = "MyWorld",
        Seed = new Random().Next(1, 999999),
        Theme = "Cyberpunk",
        Regions = 5,
        Flavor = "Dark and gritty",
        Description = "A sprawling megacity",
        MainPlotPoint = "Uncover the conspiracy",
        TimePeriod = "2089",
        PowerStructure = "Corporations and hackers"
    };

    private string selectedModel = "tinyllama-q4";
    private bool isInitializing = false;
    private bool isGenerating = false;
    private string initProgress = "";
    private string generationProgress = "";
    private int progressPercentage = 0;
    private string errorMessage = "";
    private string exportPath = "";
    private WorldGenerationResult? generatedWorld;

    protected override void OnInitialized()
    {
        selectedModel = AISettings.Value.LLamaModelKey ?? "tinyllama-q4";
    }

    private void SelectModel(string model)
    {
        selectedModel = model;
        StateHasChanged();
    }

    private async Task InitializeAI()
    {
        try
        {
            isInitializing = true;
            errorMessage = "";
            initProgress = $"Starting initialization...";
            StateHasChanged();

            AISettings.Value.LLamaModelKey = selectedModel;
            AISettings.Value.Model = selectedModel;

            var progress = new Progress<DownloadProgress>(p =>
            {
                if (p.PercentComplete % 5 == 0 || p.PercentComplete == 100)
                {
                    var downloadedMB = p.DownloadedBytes / 1024.0 / 1024.0;
                    var totalMB = p.TotalBytes / 1024.0 / 1024.0;
                    var speedMB = p.SpeedBytesPerSecond / 1024.0 / 1024.0;
                    initProgress = $"Downloading: {downloadedMB:F0}/{totalMB:F0} MB ({p.PercentComplete}%) - {speedMB:F1} MB/s";
                    InvokeAsync(StateHasChanged);
                }
            });

            await GenerationService.InitializeAsync(progress);
            initProgress = $"Initialized successfully";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize AI");
            errorMessage = $"Failed to initialize: {ex.Message}";
            initProgress = "";
        }
        finally
        {
            isInitializing = false;
            StateHasChanged();
        }
    }

    private async Task GenerateWorld()
    {
        try
        {
            isGenerating = true;
            errorMessage = "";
            generatedWorld = null;
            exportPath = "";
            progressPercentage = 0;
            StateHasChanged();

            var progress = new Progress<string>(msg =>
            {
                generationProgress = msg;
                progressPercentage = msg switch
                {
                    var m when m.Contains("Starting") => 10,
                    var m when m.Contains("structure") => 40,
                    var m when m.Contains("Validating") => 80,
                    var m when m.Contains("complete") => 100,
                    _ => progressPercentage
                };
                InvokeAsync(StateHasChanged);
            });

            generatedWorld = await GenerationService.GenerateWorldAsync(options, progress);

            var outputDir = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
                "source", "repos", "SoloAdventureSystem", "content", "worlds");

            exportPath = GenerationService.ExportWorld(generatedWorld, options, outputDir);
            generationProgress = "Complete";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to generate world");
            errorMessage = $"Failed to generate: {ex.Message}";
            generationProgress = "";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

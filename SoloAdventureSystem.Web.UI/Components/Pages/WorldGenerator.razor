@page "/generate"
@rendermode InteractiveServer
@using SoloAdventureSystem.ContentGenerator
@using SoloAdventureSystem.ContentGenerator.Models
@using SoloAdventureSystem.ContentGenerator.Configuration
@using SoloAdventureSystem.ContentGenerator.EmbeddedModel
@using SoloAdventureSystem.ContentGenerator.Adapters
@using SoloAdventureSystem.Web.UI.Services
@using SoloAdventureSystem.ContentGenerator.Generation
@using Microsoft.Extensions.Options
@inject WorldGenerationService GenerationService
@inject IOptions<AISettings> AISettings
@inject ILogger<WorldGenerator> Logger

<PageTitle>AI World Generator</PageTitle>

<div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1 class="display-4" style="font-weight: 700; color: var(--color-text-primary);">AI World Generator</h1>
        <p class="lead" style="color: var(--color-text-secondary);">Generate procedural game worlds using local LLM models</p>
    </div>

    @if (!GenerationService.IsInitialized)
    {
        <Card Style="margin-bottom: 2rem;">
            <div style="padding: 1.5rem;">
                <h4 style="color: var(--color-text-primary); margin-bottom: 1rem;">Select AI Model</h4>
                
                <!-- Model Management Section -->
                <div style="margin-bottom: 2rem; padding: 1rem; background: var(--color-bg-secondary); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5 style="color: var(--color-text-primary); margin: 0;">Model Management</h5>
                        <Button Appearance="outline" 
                                OnClick="LoadCachedModels"
                                Style="padding: 4px 8px;">
                            ?? Refresh
                        </Button>
                    </div>
                    
                    @if (cachedModels.Count > 0)
                    {
                        <div style="margin-bottom: 1rem;">
                            <div class="small" style="color: var(--color-text-muted); margin-bottom: 0.5rem;">
                                Cached Models (@cachedModels.Count) - Total: @FormatFileSize(totalCacheSize)
                            </div>
                            
                            @foreach (var model in cachedModels)
                            {
                                <div style="display: flex; justify-content: space-between; align-items: center; 
                                          padding: 0.5rem; margin-bottom: 0.5rem; background: var(--color-bg-primary); 
                                          border-radius: 4px;">
                                    <div>
                                        <strong style="color: var(--color-text-primary);">@model.Key</strong>
                                        <div class="small" style="color: var(--color-text-muted);">
                                            @FormatFileSize(model.Value.SizeBytes) - Modified: @model.Value.LastModified.ToString("yyyy-MM-dd HH:mm")
                                        </div>
                                    </div>
                                    <Button Appearance="secondary" 
                                            OnClick="() => DeleteModel(model.Key)"
                                            Style="padding: 4px 8px; font-size: 0.8rem;">
                                        ??? Delete
                                    </Button>
                                </div>
                            }
                            
                            <div style="margin-top: 1rem, text-align: center;">
                                <Button Appearance="outline" 
                                        OnClick="DeleteAllModels"
                                        Style="padding: 6px 12px;">
                                    ??? Delete All Cached Models
                                </Button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div style="text-align: center; color: var(--color-text-muted); padding: 1rem;">
                            No cached models found. Models will be downloaded when first used.
                        </div>
                    }
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- TinyLlama -->
                    <div class="model-card @(selectedModel == "tinyllama-q4" ? "selected" : "")" 
                         @onclick='() => SelectModel("tinyllama-q4")'>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h5 style="color: var(--color-text-primary);">TinyLlama</h5>
                            <span class="model-badge badge-speed-fast">FASTEST</span>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var(--color-text-muted);">SIZE</div>
                            <div class="h4" style="color: var(--color-text-primary);">~700 MB</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var(--color-text-muted);">DOWNLOAD</div>
                            <div style="color: var(--color-text-primary);">2-5 minutes</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var,--color-text-muted);">SPEED</div>
                            <div style="color: var,--color-text-primary);">30-45 seconds</div>
                        </div>
                        <span class="model-badge badge-quality-good">Good Quality</span>
                    </div>

                    <!-- Llama-3.2 -->
                    <div class="model-card @(selectedModel == "llama-3.2-1b-q4" ? "selected" : "")" 
                         @onclick='() => SelectModel("llama-3.2-1b-q4")'>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h5 style="color: var(--color-text-primary);">Llama 3.2</h5>
                            <span class="model-badge badge-speed-medium">BALANCED</span>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var(--color-text-muted);">SIZE</div>
                            <div class="h4" style="color: var(--color-text-primary);">~2 GB</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var,--color-text-muted);">DOWNLOAD</div>
                            <div style="color: var(--color-text-primary);">4-8 minutes</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var,--color-text-muted);">SPEED</div>
                            <div style="color: var(--color-text-primary);">1-2 minutes</div>
                        </div>
                        <span class="model-badge badge-quality-best">Excellent</span>
                    </div>

                    <!-- Phi-3 Mini -->
                    <div class="model-card @(selectedModel == "phi-3-mini-q4" ? "selected" : "")" 
                         @onclick='() => SelectModel("phi-3-mini-q4")'>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h5 style="color: var(--color-text-primary);">Phi-3 Mini</h5>
                            <span class="model-badge badge-quality-best">BEST</span>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var,--color-text-muted);">SIZE</div>
                            <div class="h4" style="color: var,--color-text-primary);">~2.3 GB</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var,--color-text-muted);">DOWNLOAD</div>
                            <div style="color: var(--color-text-primary);">5-10 minutes</div>
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <div class="small" style="color: var,--color-text-muted);">SPEED</div>
                            <div style="color: var(--color-text-primary);">1-2 minutes</div>
                        </div>
                        <span class="model-badge badge-quality-best">Best Quality</span>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <Button Appearance="accent" 
                            OnClick="InitializeAI" 
                            Disabled="@(isInitializing || string.IsNullOrEmpty(selectedModel))"
                            Style="padding: 12px 32px; width: auto;">
                        @if (isInitializing)
                        {
                            <span class="spinner-small"></span>
                            <span style="margin-left: 8px;">Initializing...</span>
                        }
                        else
                        {
                            <span>Initialize @selectedModel</span>
                        }
                    </Button>
                </div>

                @if (!string.IsNullOrEmpty(initProgress))
                {
                    <div class="message-bar message-bar-info">
                        <div class="message-icon">?</div>
                        <div class="message-content">
                            <strong>Progress:</strong> <span>@initProgress</span>
                        </div>
                    </div>
                }

                <div class="message-bar message-bar-info">
                    <div class="message-icon">?</div>
                    <div class="message-content">
                        <strong>GPU Acceleration:</strong>
                        <Badge Appearance="@(AISettings.Value.UseGPU ? "accent" : "neutral")" Style="margin-left: 8px;">
                            @(AISettings.Value.UseGPU ? "ENABLED" : "DISABLED")
                        </Badge>
                        @if (AISettings.Value.UseGPU)
                        {
                            <div class="small" style="margin-top: 8px;">Using CUDA for faster generation</div>
                        }
                    </div>
                </div>
            </div>
        </Card>
    }
    else
    {
        <Card Style="margin-bottom: 2rem;">
            <div style="padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h4 style="color: var(--color-text-primary); margin: 0;">World Configuration</h4>
                    <div style="display: flex; gap: 0.5rem;">
                        <Badge Appearance="accent">AI READY</Badge>
                        <Badge Appearance="neutral">@selectedModel</Badge>
                    </div>
                </div>

                <EditForm Model="@options" OnValidSubmit="@GenerateWorld">
                    <h6 style="color: var(--color-text-primary); margin-bottom: 1rem;">Basic Settings</h6>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <TextField Label="World Name" @bind-Value="options.Name" />
                        <NumberField Label="Random Seed" @bind-Value="options.Seed" />
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                        <TextField Label="Theme" @bind-Value="options.Theme" />
                        <NumberField Label="Regions" @bind-Value="options.Regions" Min="3" Max="20" />
                    </div>

                    <h6 style="color: var(--color-text-primary); margin-bottom: 1rem;">Advanced Settings</h6>

                    <TextField Label="Flavor/Mood" @bind-Value="options.Flavor" Style="margin-bottom: 1rem;" />
                    <TextArea Label="Setting Description" @bind-Value="options.Description" Rows="2" Style="margin-bottom: 1rem;" />
                    <TextField Label="Main Plot Point" @bind-Value="options.MainPlotPoint" Style="margin-bottom: 1rem;" />

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <TextField Label="Time Period" @bind-Value="options.TimePeriod" />
                        <TextField Label="Power Structure" @bind-Value="options.PowerStructure" />
                    </div>

                    <Button Appearance="accent" 
                            Type="submit" 
                            Disabled="@isGenerating"
                            Style="width: 100%; padding: 14px;">
                        @if (isGenerating)
                        {
                            <span class="spinner-small"></span>
                            <span style="margin-left: 8px;">Generating...</span>
                        }
                        else
                        {
                            <span>Generate World</span>
                        }
                    </Button>

                    <!-- Debug: log current options without generating -->
                    <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                        <Button Appearance="outline" OnClick="LogOptions" Disabled="@(isGenerating)" Style="padding:8px 12px;">
                            Log Options
                        </Button>
                        @if (!string.IsNullOrEmpty(lastLoggedOptions))
                        {
                            <div class="message-bar message-bar-info" style="margin:0; align-items:center;">
                                <div class="message-content" style="padding:0.25rem 0.5rem;">Last logged: @lastLoggedOptions</div>
                            </div>
                        }
                    </div>
                </EditForm>

                @if (!string.IsNullOrEmpty(generationProgress))
                {
                    <div style="margin-top: 1.5rem;">
                        <ProgressBar Value="@progressPercentage" Max="100" Style="width: 100%; margin-bottom: 1rem;" />
                        <div style="color: var(--color-text-primary);"><strong>Status:</strong> @generationProgress</div>
                    </div>
                }
            </div>
        </Card>

        @if (generatedWorld != null)
        {
            <Card Style="margin-bottom: 2rem;">
                <div style="padding: 1.5rem;">
                    <h4 style="color: var(--color-text-primary); margin-bottom: 1.5rem;">Generation Complete</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2rem; text-align: center; margin-bottom: 1.5rem;">
                        <div>
                            <div class="stat-value">@generatedWorld.Rooms.Count</div>
                            <div class="text-muted">Rooms</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.Npcs.Count</div>
                            <div class="text-muted">NPCs</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.Factions.Count</div>
                            <div class="text-muted">Factions</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.LoreEntries.Count</div>
                            <div class="text-muted">Lore</div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(exportPath))
                    {
                        <div class="message-bar message-bar-success">
                            <div class="message-icon">?</div>
                            <div class="message-content">
                                <h6 style="margin: 0 0 0.5rem 0;">Exported Successfully</h6>
                                <code style="background: var(--color-bg-primary); padding: 4px 8px; border-radius: 4px; display: block; margin-bottom: 0.5rem;">@exportPath</code>
                                <div class="small">@FormatFileSize(new FileInfo(exportPath).Length)</div>
                            </div>
                        </div>
                    }
                </div>
            </Card>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                <Card>
                    <div style="padding: 1.5rem;">
                        <h5 style="color: var(--color-text-primary); margin-bottom: 1rem;">First Room</h5>
                        <div class="preview-card">
                            <h6>@generatedWorld.Rooms[0].Title</h6>
                            <p>@generatedWorld.Rooms[0].BaseDescription</p>
                        </div>
                    </div>
                </Card>

                @if (generatedWorld.Npcs.Count > 0)
                {
                    <Card>
                        <div style="padding: 1.5rem;">
                            <h5 style="color: var(--color-text-primary); margin-bottom: 1rem;">First NPC</h5>
                            <div class="preview-card">
                                <h6>@generatedWorld.Npcs[0].Name</h6>
                                <p>@generatedWorld.Npcs[0].Description</p>
                            </div>
                        </div>
                    </Card>
                }
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="message-bar message-bar-error">
                <div class="message-icon">?</div>
                <div class="message-content">
                    <h5 style="margin: 0 0 0.5rem 0;">Error</h5>
                    <p style="margin: 0;">@errorMessage</p>
                </div>
            </div>
        }
    }
</div>

<style>
.spinner-small {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

@code {
    private WorldGenerationOptions options = new()
    {
        Name = "MyWorld",
        Seed = new Random().Next(1, 999999),
        Theme = "Cyberpunk",
        Regions = 5,
        Flavor = "Dark and gritty",
        Description = "A sprawling megacity",
        MainPlotPoint = "Uncover the conspiracy",
        TimePeriod = "2089",
        PowerStructure = "Corporations and hackers"
    };

    private string selectedModel = "tinyllama-q4";
    private bool isInitializing = false;
    private bool isGenerating = false;
    private string initProgress = "";
    private string generationProgress = "";
    private int progressPercentage = 0;
    private string errorMessage = "";
    private string exportPath = "";
    private WorldGenerationResult? generatedWorld;
    
    // Model management
    private List<ModelCacheInfo> cachedModels = new();
    private long totalCacheSize = 0;

    private class ModelCacheInfo
    {
        public string Key { get; set; } = "";
        public CachedModelInfo Value { get; set; } = new();
    }

    // Debug UI hint
    private string lastLoggedOptions = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadCachedModels();
        selectedModel = AISettings.Value.LLamaModelKey ?? "tinyllama-q4";
    }

    private void SelectModel(string model)
    {
        selectedModel = model;
        StateHasChanged();
    }

    private async Task LoadCachedModels()
    {
        try
        {
            var cached = GGUFModelDownloader.GetCachedModels();
            cachedModels = cached.Select(kvp => new ModelCacheInfo { Key = kvp.Key, Value = kvp.Value }).ToList();
            totalCacheSize = GGUFModelDownloader.GetTotalCacheSize();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load cached models");
            errorMessage = $"Failed to load model cache: {ex.Message}";
        }
    }

    private async Task DeleteModel(string modelKey)
    {
        try
        {
            GGUFModelDownloader.DeleteModel(modelKey);
            Logger.LogInformation("Deleted cached model: {ModelKey}", modelKey);
            
            // If this was the currently selected model, show a message
            if (selectedModel == modelKey)
            {
                errorMessage = $"Deleted model '{modelKey}'. Select a different model to continue.";
            }
            
            await LoadCachedModels(); // Refresh the list
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete model {ModelKey}", modelKey);
            errorMessage = $"Failed to delete model '{modelKey}': {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task DeleteAllModels()
    {
        try
        {
            var modelsDir = GGUFModelDownloader.GetModelCacheDirectory();
            if (Directory.Exists(modelsDir))
            {
                var modelFiles = Directory.GetFiles(modelsDir, "*.gguf");
                foreach (var file in modelFiles)
                {
                    File.Delete(file);
                }
                
                Logger.LogInformation("Deleted all cached models ({Count} files)", modelFiles.Length);
                errorMessage = $"Deleted all cached models ({modelFiles.Length} files). Models will be re-downloaded when needed.";
                
                await LoadCachedModels(); // Refresh the list
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete all models");
            errorMessage = $"Failed to delete all models: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task InitializeAI()
    {
        try
        {
            isInitializing = true;
            errorMessage = "";
            initProgress = $"Starting initialization...";
            StateHasChanged();

            AISettings.Value.LLamaModelKey = selectedModel;
            AISettings.Value.Model = selectedModel;

            var progress = new Progress<DownloadProgress>(p =>
            {
                if (p.PercentComplete % 5 == 0 || p.PercentComplete == 100)
                {
                    var downloadedMB = p.DownloadedBytes / 1024.0 / 1024.0;
                    var totalMB = p.TotalBytes / 1024.0 / 1024.0;
                    var speedMB = p.SpeedBytesPerSecond / 1024.0 / 1024.0;
                    initProgress = $"Downloading: {downloadedMB:F0}/{totalMB:F0} MB ({p.PercentComplete}%) - {speedMB:F1} MB/s";
                    InvokeAsync(StateHasChanged);
                }
            });

            await GenerationService.InitializeAsync(progress);
            initProgress = $"Initialized successfully";
            
            // Refresh cached models after initialization (in case a new one was downloaded)
            await LoadCachedModels();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize AI");
            errorMessage = $"Failed to initialize: {ex.Message}";
            initProgress = "";
        }
        finally
        {
            isInitializing = false;
            StateHasChanged();
        }
    }

    private async Task GenerateWorld()
    {
        try
        {
            isGenerating = true;
            errorMessage = "";
            generatedWorld = null;
            exportPath = "";
            progressPercentage = 0;
            StateHasChanged();

            // Log the options being used for generation to server logs (helps debug binding issues)
            Logger.LogInformation("[WorldGenerator] GenerateWorld invoked. Options => Name={Name}, Seed={Seed}, Theme={Theme}, Regions={Regions}, Flavor={Flavor}, Description={Description}, MainPlotPoint={MainPlotPoint}, TimePeriod={TimePeriod}, PowerStructure={PowerStructure}",
                options.Name, options.Seed, options.Theme, options.Regions, options.Flavor, options.Description, options.MainPlotPoint, options.TimePeriod, options.PowerStructure);

            var progress = new Progress<string>(msg =>
            {
                generationProgress = msg;
                progressPercentage = msg switch
                {
                    var m when m.Contains("Starting") => 10,
                    var m when m.Contains("structure") => 40,
                    var m when m.Contains("Validating") => 80,
                    var m when m.Contains("complete") => 100,
                    _ => progressPercentage
                };
                InvokeAsync(StateHasChanged);
            });

            generatedWorld = await GenerationService.GenerateWorldAsync(options, progress);

            var outputDir = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
                "source", "repos", "SoloAdventureSystem", "content", "worlds");

            exportPath = GenerationService.ExportWorld(generatedWorld, options, outputDir);
            generationProgress = "Complete";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to generate world");
            errorMessage = $"Failed to generate: {ex.Message}";
            generationProgress = "";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task LogOptions()
    {
        // Log to server and update small UI hint so you can confirm the action from the browser
        try
        {
            Logger.LogInformation("[WorldGenerator][Debug] Current options: Name={Name}, Seed={Seed}, Theme={Theme}, Regions={Regions}, Flavor={Flavor}, Description={Description}, MainPlotPoint={MainPlotPoint}, TimePeriod={TimePeriod}, PowerStructure={PowerStructure}",
                options.Name, options.Seed, options.Theme, options.Regions, options.Flavor, options.Description, options.MainPlotPoint, options.TimePeriod, options.PowerStructure);

            lastLoggedOptions = $"{options.Name} (seed {options.Seed})";
            // keep the message visible briefly
            StateHasChanged();
            await Task.Delay(2500);
            lastLoggedOptions = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to log options");
            errorMessage = $"Failed to log options: {ex.Message}";
            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

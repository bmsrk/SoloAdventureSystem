@page "/generate"
@rendermode InteractiveServer
@using SoloAdventureSystem.ContentGenerator
@using SoloAdventureSystem.ContentGenerator.Models
@using SoloAdventureSystem.ContentGenerator.Configuration
@using SoloAdventureSystem.ContentGenerator.EmbeddedModel
@using SoloAdventureSystem.ContentGenerator.Adapters
@using SoloAdventureSystem.Web.UI.Services
@using SoloAdventureSystem.ContentGenerator.Generation
@using Microsoft.Extensions.Options
@inject WorldGenerationService GenerationService
@inject IOptions<AISettings> AISettings
@inject ILogger<WorldGenerator> Logger

<PageTitle>AI World Generator</PageTitle>

<div style="padding: 1.5rem; max-width: 1200px; margin: 0 auto;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
        <div>
            <h2 style="margin:0; color:var(--color-text-primary);">AI World Generator</h2>
            <div style="color:var(--color-text-muted); font-size:0.95rem;">Generate procedural game worlds using local LLM models</div>
        </div>
        <div style="display:flex; gap:0.5rem; align-items:center;">
            @if (!GenerationService.IsInitialized)
            {
                <select @bind="selectedModel" style="padding:6px 8px; border-radius:6px; border:1px solid var(--color-border-default); background:var(--color-bg-primary); color:var(--color-text-primary);">
                    <option value="tinyllama-q4">TinyLlama</option>
                    <option value="llama-3.2-1b-q4">Llama-3.2</option>
                    <option value="phi-3-mini-q4">Phi-3 Mini</option>
                </select>
                <div style="font-size:0.85rem; color:var(--color-text-muted);">@GetModelEstimate(selectedModel)</div>
                <Button Appearance="outline" OnClick="InitializeModel" Disabled="@isInitializing" Style="padding:6px 10px;">@(isInitializing ? "Init..." : "Init")</Button>
            }
            else
            {
                <div style="font-size:0.95rem; color:var(--color-text-primary);">Model: <strong>@selectedModel</strong></div>
            }
            <Button Appearance="outline" OnClick="() => showLogPane = !showLogPane">@(showLogPane ? "Hide Logs" : "Show Logs")</Button>
            <Badge Appearance="@(GenerationService.IsInitialized ? "accent" : "neutral")">@(GenerationService.IsInitialized ? "AI READY" : "AI NOT INITIALIZED")</Badge>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: @(showLogPane ? "320px 1fr" : "1fr"); gap:1rem;">
        @if (showLogPane)
        {
            <aside style="background:var(--color-bg-secondary); padding:0.75rem; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <strong style="color:var(--color-text-primary);">Activity Log</strong>
                    <Button Appearance="ghost" OnClick="ClearUiLog">Clear</Button>
                </div>

                <div style="font-size:0.85rem; color:var(--color-text-muted); margin-bottom:0.5rem;">Status</div>
                <div style="font-size:0.9rem; color:var(--color-text-primary); margin-bottom:0.5rem;">Initialization: @initProgress</div>
                <div style="font-size:0.9rem; color:var(--color-text-primary);">Generation: @generationProgress</div>

                <div style="height:1px; background:var(--color-border-default); margin:0.5rem 0;"></div>

                <div style="font-size:0.85rem; color:var(--color-text-muted); margin-bottom:0.5rem;">Recent Actions</div>
                <div style="max-height:44vh; overflow:auto; white-space:pre-wrap; font-family:monospace; font-size:0.85rem; color:var(--color-text-secondary); background:var(--color-bg-primary); padding:0.5rem; border-radius:6px;">
                    @if (string.IsNullOrEmpty(uiLog))
                    {
                        <div style="color:var(--color-text-muted);">No log messages yet</div>
                    }
                    else
                    {
                        @uiLog
                    }
                </div>
            </aside>
        }

        <section>
            <Card Style="padding:1rem;">
                <EditForm Model="@options" OnValidSubmit="@GenerateWorld">
                    <div style="display:flex; gap:1rem; align-items:end; margin-bottom:0.75rem;">
                        <TextField Label="World Name" @bind-Value="options.Name" Style="width:240px;" />
                        <NumberField Label="Seed" @bind-Value="options.Seed" Style="width:140px;" />
                        <TextField Label="Theme" @bind-Value="options.Theme" Style="width:180px;" />
                        <NumberField Label="Regions" @bind-Value="options.Regions" Min="3" Max="20" Style="width:120px;" />
                    </div>

                    <div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem;">
                        <Button Appearance="accent" Type="submit" Disabled="@isGenerating" Style="padding:8px 16px;">@if (isGenerating) { <span class="spinner-small"></span> } Generate</Button>
                        <Button Appearance="outline" OnClick="LogOptions" Disabled="@isGenerating">Log</Button>
                        <Button Appearance="ghost" OnClick="() => showAdvanced = !showAdvanced">@(showAdvanced ? "Hide Advanced" : "Show Advanced")</Button>
                        <div style="margin-left:auto; color:var(--color-text-muted); font-size:0.9rem;">Model: <strong>@selectedModel</strong></div>
                    </div>

                    @if (showAdvanced)
                    {
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; margin-bottom:0.5rem;">
                            <TextField Label="Flavor/Mood" @bind-Value="options.Flavor" />
                            <TextField Label="Main Plot" @bind-Value="options.MainPlotPoint" />
                            <TextArea Label="Short Setting Description" @bind-Value="options.Description" Rows="2" />
                            <div />
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(generationProgress))
                    {
                        <div style="margin-top:0.5rem;">
                            <ProgressBar Value="@progressPercentage" Max="100" Style="width:100%; margin-bottom:0.5rem;" />
                            <div style="font-size:0.9rem; color:var(--color-text-muted);">@generationProgress</div>
                        </div>
                    }
                </EditForm>
            </Card>

            @if (generatedWorld != null)
            {
                <Card Style="margin-top:0.75rem; padding:0.75rem;">
                    <div style="display:flex; gap:1rem; align-items:center;">
                        <div>
                            <div class="stat-value">@generatedWorld.Rooms.Count</div>
                            <div class="text-muted">Rooms</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.Npcs.Count</div>
                            <div class="text-muted">NPCs</div>
                        </div>
                        <div>
                            <div class="stat-value">@generatedWorld.Factions.Count</div>
                            <div class="text-muted">Factions</div>
                        </div>
                        <div style="margin-left:auto;">
                            @if (!string.IsNullOrEmpty(exportPath))
                            {
                                <div class="message-bar message-bar-success">
                                    <div class="message-content">Exported: <code>@exportPath</code></div>
                                </div>
                            }
                        </div>
                    </div>
                </Card>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="message-bar message-bar-error" style="margin-top:0.75rem;">
                    <div class="message-content">@errorMessage</div>
                </div>
            }
        </section>
    </div>
</div>

<style>
.spinner-small { display:inline-block; width:14px; height:14px; border:2px solid rgba(255,255,255,0.3); border-top:2px solid white; border-radius:50%; animation:spin 1s linear infinite; }
@@keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
</style>

@code {
    private WorldGenerationOptions options = new()
    {
        Name = "MyWorld",
        Seed = new Random().Next(1, 999999),
        Theme = "Cyberpunk",
        Regions = 5,
        Flavor = "Dark and gritty",
        Description = "A sprawling megacity",
        MainPlotPoint = "Uncover the conspiracy",
        TimePeriod = "2089",
        PowerStructure = "Corporations and hackers"
    };

    private string selectedModel = "tinyllama-q4";
    private bool isInitializing = false;
    private bool isGenerating = false;
    private string initProgress = "";
    private string generationProgress = "";
    private int progressPercentage = 0;
    private string errorMessage = "";
    private string exportPath = "";
    private WorldGenerationResult? generatedWorld;

    private bool showLogPane = true;
    private bool showAdvanced = false;

    // Small UI log for the left pane
    private string uiLog = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadCachedModels();
        selectedModel = AISettings.Value.LLamaModelKey ?? "tinyllama-q4";
    }

    private void AppendUiLog(string msg)
    {
        uiLog = $"{DateTime.Now:HH:mm:ss} {msg}\n" + uiLog;
        // keep limited size
        if (uiLog.Length > 20000) uiLog = uiLog.Substring(0, 20000);
        StateHasChanged();
    }

    private void ClearUiLog()
    {
        uiLog = "";
    }

    private async Task GenerateWorld()
    {
        try
        {
            isGenerating = true; errorMessage = ""; generatedWorld = null; exportPath = ""; progressPercentage = 0;
            AppendUiLog($"Generate requested: {options.Name} (seed {options.Seed})");

            var progress = new Progress<string>(msg =>
            {
                generationProgress = msg;
                progressPercentage = msg switch
                {
                    var m when m.Contains("Starting") => 10,
                    var m when m.Contains("structure") => 40,
                    var m when m.Contains("Validating") => 80,
                    var m when m.Contains("complete") => 100,
                    _ => progressPercentage
                };
                AppendUiLog($"Progress: {msg}");
            });

            // Ensure AI initialized
            if (!GenerationService.IsInitialized)
            {
                AppendUiLog("Initializing AI adapter...");
                var dp = new Progress<DownloadProgress>(p => { initProgress = $"{p.PercentComplete}%"; AppendUiLog($"Init: {p.PercentComplete}%"); });
                await GenerationService.InitializeAsync(dp);
                AppendUiLog("AI initialized");
            }

            generatedWorld = await GenerationService.GenerateWorldAsync(options, progress);
            exportPath = GenerationService.ExportWorld(generatedWorld, options, Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "source", "repos", "SoloAdventureSystem", "content", "worlds"));
            generationProgress = "Complete";
            AppendUiLog($"Generation complete. Saved to {exportPath}");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message; AppendUiLog($"ERROR: {ex.Message}");
        }
        finally
        {
            isGenerating = false; StateHasChanged();
        }
    }

    private Task LogOptions()
    {
        AppendUiLog($"Options: {options.Name} seed={options.Seed} regions={options.Regions}");
        return Task.CompletedTask;
    }

    // lightweight helpers copied from previous file to keep functionality
    private List<ModelCacheInfo> cachedModels = new();
    private long totalCacheSize = 0;

    private class ModelCacheInfo { public string Key { get; set; } = ""; public CachedModelInfo Value { get; set; } = new(); }

    private async Task LoadCachedModels()
    {
        try
        {
            var cached = GGUFModelDownloader.GetCachedModels();
            cachedModels = cached.Select(kvp => new ModelCacheInfo { Key = kvp.Key, Value = kvp.Value }).ToList();
            totalCacheSize = GGUFModelDownloader.GetTotalCacheSize();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load cached models");
            AppendUiLog($"Failed to load cached models: {ex.Message}");
        }
    }

    private async Task InitializeModel()
    {
        if (isInitializing) return;
        try
        {
            isInitializing = true;
            AppendUiLog($"Initializing model: {selectedModel}");

            // Update runtime settings so GenerationService uses selected model
            try { AISettings.Value.LLamaModelKey = selectedModel; AISettings.Value.Model = selectedModel; } catch { }

            var dp = new Progress<DownloadProgress>(p =>
            {
                initProgress = $"{p.PercentComplete}%";
                AppendUiLog($"Init: {p.PercentComplete}%");
            });

            await GenerationService.InitializeAsync(dp);
            AppendUiLog("AI initialized");
            await LoadCachedModels();
        }
        catch (Exception ex)
        {
            AppendUiLog($"Init failed: {ex.Message}");
            errorMessage = ex.Message;
        }
        finally
        {
            isInitializing = false;
            StateHasChanged();
        }
    }

    private string GetModelEstimate(string modelKey)
    {
        // Minimal inline estimates (size / download time on typical connection)
        return modelKey switch
        {
            "tinyllama-q4" => "~700 MB — ~1-3 min",
            "llama-3.2-1b-q4" => "~2 GB — ~3-6 min",
            "phi-3-mini-q4" => "~2.3 GB — ~4-8 min",
            _ => "Unknown size",
        };
    }
}

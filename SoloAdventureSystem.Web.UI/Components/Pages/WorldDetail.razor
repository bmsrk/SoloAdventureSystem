@page "/worlds/{id}"
@rendermode InteractiveServer
@using System.IO
@using System.IO.Compression
@using System.Text.Json
@using SoloAdventureSystem.Engine.WorldLoader
@using SoloAdventureSystem.Engine.Models
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>World Details - @(world?.WorldDefinition?.Name ?? "Loading...")</PageTitle>

<link rel="stylesheet" href="/css/shared-pages.css" />

<div class="mud-home">
    <div class="mud-container">

        <pre class="mud-terminal">
╔══════════════════════════════════════════════════════════════════════════════╗
║                           WORLD DETAILS TERMINAL                           ║
╚══════════════════════════════════════════════════════════════════════════════╝
        </pre>

        @if (isLoading)
        {
            <div class="loading-state">
                <pre class="loading-art">
┌─ LOADING WORLD ───────────────────────────────────────────────────────────┐
│                                                                           │
│                         Loading world data...                             │
└───────────────────────────────────────────────────────────────────────────┘
                </pre>
            </div>
        }
        else if (world == null)
        {
            <div class="empty-state">
                <pre class="error-art">
┌─ WORLD NOT FOUND ─────────────────────────────────────────────────────────┐
│                                                                           │
│                      World archive not found in system.                   │
└───────────────────────────────────────────────────────────────────────────┘
                </pre>
                <div class="empty-actions">
                    <Button Class="mud-btn" OnClick='@(() => Navigation.NavigateTo("/worlds"))'>[BACK TO WORLDS]</Button>
                </div>
            </div>
        }
        else
        {
            <div class="world-header mud-theme-bg">
                <div class="header-left">
                    <Button Class="mud-link" OnClick='@(() => Navigation.NavigateTo("/worlds"))'>&larr; Back to Worlds</Button>
                    <h1 class="world-title">@world.WorldDefinition.Name</h1>
                    <div class="world-meta">Created: @world.WorldDefinition.CreatedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</div>
                    <p class="world-desc">@world.WorldDefinition.Description</p>
                </div>
                <div class="header-actions">
                    <button type="button" class="mud-btn" @onclick="CopyRawJson">Copy JSON</button>
                    <button type="button" class="mud-btn" @onclick="DownloadWorld">Download</button>
                </div>
            </div>

            <div class="world-body">
                <div class="section">
                    <h3>Overview</h3>
                    <div class="overview-grid">
                        <div><strong>Rooms:</strong> @(world.Rooms?.Count ?? 0)</div>
                        <div><strong>NPCs:</strong> @(world.Npcs?.Count ?? 0)</div>
                        <div><strong>Factions:</strong> @(world.Factions?.Count ?? 0)</div>
                        <div><strong>Story Nodes:</strong> @(world.StoryNodes?.Count ?? 0)</div>
                    </div>
                </div>

                <div class="section">
                    <h3>Preview</h3>
                    <div class="preview">
                        @if (world.Rooms != null && world.Rooms.Any())
                        {
                            <div class="preview-item">
                                <strong>Start Location:</strong> @world.WorldDefinition.StartLocationId
                                <p class="mono">@world.Rooms.FirstOrDefault(r => r.Id == world.WorldDefinition.StartLocationId)?.Description</p>
                            </div>
                        }
                    </div>
                </div>

                <div class="section">
                    <h3>Export</h3>
                    <div class="export-actions">
                        <button type="button" class="mud-btn" @onclick="() => DownloadWorld()">Download ZIP</button>
                        <button type="button" class="mud-btn" @onclick="() => CopyRawJson()">Copy raw JSON</button>
                    </div>
                </div>
            </div>
        }

    </div>
</div>

@code {
    [Parameter] public string id { get; set; }

    private WorldModel? world;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorld();
    }

    private async Task LoadWorld()
    {
        isLoading = true;
        try
        {
            var worldsPath = GetWorldsDirectory();
            var files = Directory.GetFiles(worldsPath, "*.zip");
            var match = files.FirstOrDefault(f => Path.GetFileNameWithoutExtension(f).Equals(id, StringComparison.OrdinalIgnoreCase));
            if (match != null)
            {
                using var zip = ZipFile.OpenRead(match);
                var entry = zip.GetEntry("world.json");
                if (entry != null)
                {
                    using var stream = entry.Open();
                    using var reader = new StreamReader(stream);
                    var json = await reader.ReadToEndAsync();
                    var meta = JsonSerializer.Deserialize<WorldJsonModel>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    if (meta != null)
                    {
                        // Basic metadata only for preview
                        world = new WorldModel { WorldDefinition = new WorldDefinition(meta.Name, meta.Description, meta.Version, meta.Author, meta.CreatedAt, meta.StartLocationId, meta.LocationIds, meta.NpcIds, meta.ItemIds, meta.FactionIds, meta.StoryNodeIds), Rooms = new List<Location>(), Npcs = new List<NPC>(), Factions = new List<Faction>(), StoryNodes = new List<StoryNode>() };
                    }
                }
            }
        }
        catch { }
        finally { isLoading = false; }
    }

    private string GetWorldsDirectory()
    {
        return Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "source", "repos", "SoloAdventureSystem", "content", "worlds");
    }

    private async Task CopyRawJson()
    {
        if (world == null) return;
        var json = JsonSerializer.Serialize(world);
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", json);
    }

    private void DownloadWorld()
    {
        // Trigger download handled by World list or OS; this is a placeholder to keep functionality
    }

    private class WorldJsonModel { public string Name { get; set; } = ""; public string Description { get; set; } = ""; public string Version { get; set; } = ""; public string Author { get; set; } = ""; public DateTime CreatedAt { get; set; } public String StartLocationId { get; set; } = ""; public List<String> LocationIds { get; set; } = new(); public List<String> NpcIds { get; set; } = new(); public List<String> ItemIds { get; set; } = new(); public List<String> FactionIds { get; set; } = new(); public List<String> StoryNodeIds { get; set; } = new(); }
}

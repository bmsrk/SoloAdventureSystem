@page "/select-world"
@rendermode InteractiveServer
@using System.IO
@using System.IO.Compression
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Select World</PageTitle>

<div class="terminal-select">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">Select World</h1>
            <p class="page-description">Choose a generated world to begin your adventure</p>
        </div>
        <div class="header-actions">
            <a href="/generate" class="btn-primary">
                <span class="btn-icon">?</span>
                Generate New World
            </a>
            <a href="/worlds" class="btn-secondary">
                <span class="btn-icon">??</span>
                Manage Worlds
            </a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading worlds...</p>
        </div>
    }
    else if (worlds.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">??</div>
            <h2 class="empty-title">No Worlds Available</h2>
            <p class="empty-description">
                Create a world first using the world generator to begin your adventure.
            </p>
            <a href="/generate" class="btn-primary">
                <span class="btn-icon">??</span>
                Generate World
            </a>
        </div>
    }
    else
    {
        <div class="worlds-stats">
            <div class="stat-card">
                <div class="stat-icon">??</div>
                <div class="stat-content">
                    <div class="stat-value">@worlds.Count</div>
                    <div class="stat-label">Worlds Available</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">??</div>
                <div class="stat-content">
                    <div class="stat-value">@FormatBytes(worlds.Sum(w => w.FileSize))</div>
                    <div class="stat-label">Total Size</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">??</div>
                <div class="stat-content">
                    <div class="stat-value">@worlds.Max(w => w.Created).ToString("MMM dd")</div>
                    <div class="stat-label">Latest World</div>
                </div>
            </div>
        </div>

        <div class="worlds-grid">
            @foreach (var world in worlds.OrderByDescending(w => w.Created))
            {
                <div class="world-card" @onclick="() => PlayWorld(world.FilePath)">
                    <div class="card-header">
                        <div class="world-icon">
                            @world.Name.Substring(0, 1).ToUpper()
                        </div>
                        <div class="world-info">
                            <h3 class="world-name">@world.Name</h3>
                            <div class="world-meta">
                                <span class="meta-item">
                                    <span class="meta-icon">??</span>
                                    Seed: @world.Seed
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">??</span>
                                    @world.Created.ToString("MMM dd, yyyy")
                                </span>
                                <span class="meta-item">
                                    <span class="meta-icon">??</span>
                                    @FormatBytes(world.FileSize)
                                </span>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(world.Description))
                    {
                        <div class="world-description">
                            @world.Description
                        </div>
                    }

                    <div class="card-actions">
                        <button class="btn-primary" @onclick:stopPropagation="true" @onclick="() => PlayWorld(world.FilePath)">
                            <span class="btn-icon">??</span>
                            Play Game
                        </button>
                        <button class="btn-secondary" @onclick:stopPropagation="true" @onclick="() => ViewDetails(world)">
                            <span class="btn-icon">???</span>
                            Details
                        </button>
                        <button class="btn-danger" @onclick:stopPropagation="true" @onclick="() => DeleteWorld(world)">
                            <span class="btn-icon">???</span>
                            Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteDialog && worldToDelete != null)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Deletion</h3>
                <button class="modal-close" @onclick="CancelDelete">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>@worldToDelete.Name</strong>?</p>
                <p class="modal-warning">This action cannot be undone.</p>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" @onclick="CancelDelete">Cancel</button>
                <button class="btn-danger" @onclick="ConfirmDeleteWorld">Delete World</button>
            </div>
        </div>
    </div>
}

<style>
.terminal-select {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(0, 255, 255, 0.2);
}

.header-content h1 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, #ffffff, #00ffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.page-description {
    color: #b0b0b0;
    margin: 0;
    font-size: 1.125rem;
}

.btn-primary, .btn-secondary, .btn-danger {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    cursor: pointer;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, #00ffff, #0080ff);
    color: #000000;
    box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 255, 255, 0.4);
}

.btn-secondary {
    background: transparent;
    color: #00ffff;
    border: 1px solid #00ffff;
}

.btn-secondary:hover {
    background: rgba(0, 255, 255, 0.1);
}

.btn-danger {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: #ffffff;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #ee5a52, #dc4545);
}

.btn-icon {
    font-size: 1rem;
}

.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
}

.loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid #333;
    border-top: 3px solid #00ffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

.loading-text {
    color: #b0b0b0;
    font-size: 1.125rem;
    margin: 0;
}

@@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.empty-title {
    font-size: 2rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: #ffffff;
}

.empty-description {
    color: #b0b0b0;
    font-size: 1.125rem;
    margin: 0 0 2rem 0;
    max-width: 400px;
}

.worlds-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    font-size: 2rem;
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #00ffff;
    margin: 0 0 0.25rem 0;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
}

.stat-label {
    color: #b0b0b0;
    font-size: 0.875rem;
    margin: 0;
}

.worlds-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

.world-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.world-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 255, 255, 0.1);
    border-color: rgba(0, 255, 255, 0.4);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.world-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #00ffff, #0080ff);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: #000000;
    box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
}

.world-info {
    flex: 1;
}

.world-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: #ffffff;
}

.world-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: #b0b0b0;
    font-size: 0.875rem;
}

.meta-icon {
    font-size: 0.75rem;
}

.world-description {
    color: #e0e0e0;
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(0, 255, 255, 0.05);
    border-radius: 8px;
    border-left: 3px solid #00ffff;
}

.card-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal-content {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 12px;
    max-width: 400px;
    width: 100%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-title {
    margin: 0;
    color: #ffffff;
    font-size: 1.25rem;
}

.modal-close {
    background: none;
    border: none;
    color: #b0b0b0;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
}

.modal-body {
    padding: 1.5rem;
}

.modal-body p {
    margin: 0 0 1rem 0;
    color: #e0e0e0;
}

.modal-warning {
    color: #ff6b6b;
    font-weight: 500;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Responsive Design */
@@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .worlds-grid {
        grid-template-columns: 1fr;
    }

    .worlds-stats {
        grid-template-columns: 1fr;
    }

    .card-actions {
        flex-direction: column;
    }

    .world-meta {
        flex-direction: column;
        gap: 0.25rem;
    }

    .modal-actions {
        flex-direction: column;
    }
}
</style>

@code {
    private record WorldInfo(string Name, string Seed, string FilePath, string Description, DateTime Created, long FileSize);

    private List<WorldInfo> worlds = new();
    private bool isLoading = true;
    private bool showDeleteDialog = false;
    private WorldInfo? worldToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorlds();
    }

    private async Task LoadWorlds()
    {
        isLoading = true;
        worlds.Clear();

        try
        {
            var worldsPath = GetWorldsDirectory();
            if (!Directory.Exists(worldsPath))
            {
                isLoading = false;
                return;
            }

            var files = Directory.GetFiles(worldsPath, "*.zip");
            foreach (var file in files)
            {
                try
                {
                    var fi = new FileInfo(file);
                    var fileName = Path.GetFileNameWithoutExtension(file);
                    var parts = fileName.Split('_');
                    var name = parts.Length > 1 ? string.Join("_", parts[1..^1]) : fileName;
                    var seed = parts.Length > 1 ? parts[^1] : "0";

                    // Try to read world.json description if present
                    string desc = "";
                    try
                    {
                        using var zip = ZipFile.OpenRead(file);
                        var entry = zip.GetEntry("world.json");
                        if (entry != null)
                        {
                            using var s = entry.Open();
                            using var r = new StreamReader(s);
                            var json = await r.ReadToEndAsync();
                            var doc = System.Text.Json.JsonDocument.Parse(json);
                            if (doc.RootElement.TryGetProperty("Description", out var d))
                            {
                                desc = d.GetString() ?? "";
                            }
                        }
                    }
                    catch { /* ignore zip read errors per-file */ }

                    worlds.Add(new WorldInfo(name, seed, file, desc, fi.CreationTime, fi.Length));
                }
                catch { }
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetWorldsDirectory()
    {
        return Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "source", "repos", "SoloAdventureSystem", "content", "worlds");
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double len = bytes;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private void PlayWorld(string filePath)
    {
        // Navigate to /game/{seed}
        var fileName = Path.GetFileNameWithoutExtension(filePath);
        var parts = fileName.Split('_');
        var seed = parts.Length > 1 ? parts[^1] : "0";
        Navigation.NavigateTo($"/game/{Uri.EscapeDataString(seed)}");
    }

    private void ViewDetails(WorldInfo w)
    {
        Navigation.NavigateTo($"/worlds/{Uri.EscapeDataString(w.Seed)}");
    }

    private async void DeleteWorld(WorldInfo w)
    {
        worldToDelete = w;
        showDeleteDialog = true;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        worldToDelete = null;
        showDeleteDialog = false;
        StateHasChanged();
    }

    private async void ConfirmDeleteWorld()
    {
        if (worldToDelete == null) return;

        try
        {
            File.Delete(worldToDelete.FilePath);
            await LoadWorlds();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Failed to delete: {ex.Message}");
        }

        worldToDelete = null;
        showDeleteDialog = false;
        StateHasChanged();
    }
}
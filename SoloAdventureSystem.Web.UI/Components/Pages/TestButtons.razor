@page "/test"
@rendermode InteractiveServer
@inject IJSRuntime JS

<PageTitle>Diagnostics - Button Test</PageTitle>

<div style="max-width:900px;margin:2rem auto;padding:1rem;">
    <h2>Diagnostics - Button Event Test</h2>
    <p>This page tests different button types to verify Blazor events reach the server.</p>

    <div style="display:grid;gap:1rem;max-width:600px;">
        <div>
            <label>Standard HTML button (should increment):</label>
            <button class="mud-btn" @onclick="IncrementHtml">HTML Click (@htmlCount)</button>
        </div>

        <div>
            <label>Built-in Blazor button (should increment):</label>
            <button class="mud-btn" @onclick="IncrementBlazor">Blazor Click (@blazorCount)</button>
        </div>

        <div>
            <label>Custom `Button` component (should increment):</label>
            <Button Class="mud-btn" OnClick="IncrementCustom">Custom Button Click (@customCount)</Button>
        </div>

        <div>
            <label>Navigation test via custom Button (should navigate back to home):</label>
            <Button Class="mud-btn" OnClick='@(() => Navigation.NavigateTo("/"))'>Go Home</Button>
        </div>

        <div>
            <label>JS runtime availability:</label>
            <div>Blazor runtime present: <strong>@(blazorRuntimePresent ? "Yes" : "No")</strong></div>
            <div>SignalR connected (approx): <strong>@(signalrConnected ? "Probably" : "Unknown")</strong></div>
        </div>

    </div>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private int htmlCount = 0;
    private int blazorCount = 0;
    private int customCount = 0;
    private bool blazorRuntimePresent = false;
    private bool signalrConnected = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                blazorRuntimePresent = await JS.InvokeAsync<bool>("eval", "typeof Blazor !== 'undefined'");
            }
            catch { blazorRuntimePresent = false; }

            // Check for an open websocket to the blazor hub (heuristic)
            try
            {
                signalrConnected = await JS.InvokeAsync<bool>("eval", "(function(){ try{ var ws = !!window.WebSocket; return ws; }catch(e){return false;} })()");
            }
            catch { signalrConnected = false; }

            StateHasChanged();
        }
    }

    private void IncrementHtml()
    {
        htmlCount++;
    }

    private void IncrementBlazor()
    {
        blazorCount++;
    }

    private void IncrementCustom()
    {
        customCount++;
    }
}

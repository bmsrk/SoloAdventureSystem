@inherits LayoutComponentBase

<header class="terminal-nav">
    <div class="nav-container">
        <div class="nav-top-row">
            <nav class="nav-menu">
                <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">Home</NavLink>
                <NavLink class="nav-link" href="/generate">Generate</NavLink>
                <NavLink class="nav-link" href="/worlds">Worlds</NavLink>
                <NavLink class="nav-link" href="/select-world">Play</NavLink>
            </nav>

            <div class="nav-actions">
                <a class="nav-link external" href="https://github.com/bmsrk/SoloAdventureSystem" target="_blank" rel="noopener">GitHub</a>
                <!-- Theme and font selectors removed to enforce single-theme design system -->
            </div>
        </div>

        <div class="nav-brand-row">
            <div class="nav-brand">
                <pre class="ascii-header">@(" ___ ______  _______ ___ _  _______  _____   ___________ _   ____________    ")</pre>
            </div>
        </div>
    </div>
</header>

<main class="main-content">
    @Body
</main>

<div id="blazor-error-ui" class="error-modal" data-nosnippet style="display:none;">
    <div class="error-content">
        <div class="error-icon">!</div>
        <h3 class="error-title">System Error</h3>
        <p class="error-message">An unhandled error has occurred.</p>
        <div class="error-actions">
            <Button Class="error-button primary" OnClick="ReloadApplication">Reload Application</Button>
            <Button Class="error-button secondary" OnClick="DismissError">Dismiss</Button>
        </div>
    </div>
</div>

<style>
/* Nav link active styling to match theme */
.nav-link {
    color: var(--color-accent-primary);
    text-decoration: none;
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    display: inline-block;
}

.nav-link.active, .nav-link[aria-current='page'] {
    background: linear-gradient(135deg, rgba(0,255,255,0.08), rgba(0,128,255,0.06));
    border: 1px solid rgba(0,255,255,0.08);
    color: var(--color-text-primary);
    font-weight: 700;
}

.nav-menu { display:flex; gap:0.5rem; align-items:center }
</style>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;

    private string _currentTheme = "mud";
    private string _currentFont = "";

    private string currentTheme
    {
        get => _currentTheme;
        set
        {
            _currentTheme = value;
            // call JS safely
            _ = JS.InvokeVoidAsync("theme.setTheme", _currentTheme);
        }
    }

    private string currentFont
    {
        get => _currentFont;
        set
        {
            _currentFont = value;
            _ = JS.InvokeVoidAsync("theme.setFont", _currentFont);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // theme.js is loaded globally from App.razor; call init safely
                await JS.InvokeVoidAsync("theme.init");
                var saved = string.Empty;
                try { saved = await JS.InvokeAsync<string>("theme.getSavedTheme"); } catch { saved = null; }
                var savedFont = string.Empty;
                try { savedFont = await JS.InvokeAsync<string>("theme.getSavedFont"); } catch { savedFont = null; }
                if (!string.IsNullOrEmpty(saved)) currentTheme = saved;
                if (!string.IsNullOrEmpty(savedFont)) currentFont = savedFont;
                StateHasChanged();
            }
            catch (JSException)
            {
                // swallow JS errors to avoid breaking the app when theme script isn't available
            }
            catch
            {
                // swallow any exception
            }
        }
    }

    private bool IsActive(string href)
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        if (href == "/")
        {
            return currentPath == "/";
        }
        return currentPath.StartsWith(href, StringComparison.OrdinalIgnoreCase);
    }

    private async Task ReloadApplication()
    {
        try { await JS.InvokeVoidAsync("eval", "location.reload()"); } catch { }
    }

    private async Task DismissError()
    {
        try { await JS.InvokeVoidAsync("eval", "document.getElementById('blazor-error-ui').style.display='none'"); } catch { }
    }
}

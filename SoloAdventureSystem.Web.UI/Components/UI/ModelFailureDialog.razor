@using SoloAdventureSystem.ContentGenerator.Adapters
@using SoloAdventureSystem.ContentGenerator.EmbeddedModel

<div class="modal-backdrop" @onclick="OnCancel">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modelFailureTitle" @onclick:stopPropagation="true">
        <div class="modal-header">
            <h3 id="modelFailureTitle">AI Model Unavailable</h3>
        </div>

        <div class="modal-body">
            <div class="alert alert-warning">
                <p><strong>The AI model '@ModelKey' has stopped generating output.</strong></p>
                <p>This typically happens when:</p>
                <ul>
                    <li>The model file is corrupted</li>
                    <li>The prompt format is incompatible with this model</li>
                    <li>The model ran out of context space</li>
                </ul>
            </div>

            <div class="recovery-options">
                <h4>Recovery Options</h4>

                <div class="option-card">
                    <h5>Switch to TinyLlama (recommended)</h5>
                    <p>TinyLlama is smaller, faster and more stable for local usage.</p>
                    <div class="option-actions">
                        <Button Appearance="accent" OnClick="SwitchToTinyLlama">Switch to TinyLlama</Button>
                    </div>
                </div>

                <div class="option-card">
                    <h5>Delete and re-download model</h5>
                    <p>Delete the current model file and download a fresh copy on next start.</p>
                    <div class="option-actions">
                        <Button Appearance="danger" OnClick="DeleteAndRedownload">Delete & Re-download</Button>
                    </div>
                </div>

                <div class="option-card">
                    <h5>Try another model</h5>
                    <p>Switch to a different AI model available on your system.</p>
                    <div class="model-selection">
                        @foreach (var model in AvailableModels)
                        {
                            <Button Appearance="neutral" Class="model-btn" Disabled="@(model.Key == ModelKey)" OnClick="() => SwitchToModel(model.Key)">
                                @model.Name
                            </Button>
                        }
                    </div>
                </div>

                <div class="option-card">
                    <h5>Cancel</h5>
                    <p>Return to the generator and try again later.</p>
                    <div class="option-actions">
                        <Button Appearance="neutral" OnClick="OnCancel">Cancel</Button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <div class="dialog-actions">
                <Button Appearance="accent" OnClick="SwitchToTinyLlama">Switch to TinyLlama</Button>
                <Button Appearance="danger" OnClick="DeleteAndRedownload">Delete & Re-download</Button>
                <Button Appearance="neutral" OnClick="OnCancel">Dismiss</Button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string ModelKey { get; set; } = "";
    [Parameter] public int ConsecutiveFailures { get; set; }
    [Parameter] public EventCallback<string?> OnModelSelected { get; set; }
    [Parameter] public EventCallback OnCancelRequested { get; set; }

    private List<ModelInfo> AvailableModels = new()
    {
        new ModelInfo { Key = "tinyllama-q4", Name = "TinyLlama Q4 (600MB) - Most Stable" },
        new ModelInfo { Key = "phi-3-mini-q4", Name = "Phi-3 Mini Q4 (2GB) - Best Quality" },
        new ModelInfo { Key = "llama-3.2-1b-q4", Name = "Llama 3.2 1B Q4 (800MB) - Balanced" }
    };

    private async Task SwitchToTinyLlama()
    {
        await OnModelSelected.InvokeAsync("tinyllama-q4");
    }

    private async Task SwitchToModel(string modelKey)
    {
        await OnModelSelected.InvokeAsync(modelKey);
    }

    private async Task DeleteAndRedownload()
    {
        try
        {
            var modelPath = GGUFModelDownloader.GetModelPath(ModelKey);
            if (File.Exists(modelPath))
            {
                File.Delete(modelPath);
            }

            // Re-download will happen automatically on next initialization
            await OnModelSelected.InvokeAsync(ModelKey);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to delete model: {ex.Message}");
        }
    }

    private async Task OnCancel()
    {
        await OnCancelRequested.InvokeAsync();
    }

    private class ModelInfo
    {
        public string Key { get; set; } = "";
        public string Name { get; set; } = "";
    }
}

@using SoloAdventureSystem.Web.UI.Services
@inject GenerationService GenerationService

<Card Style="max-width: 920px; margin: 2rem auto;">
    <div class="terminal-header" style="padding: 1rem 1.5rem;">
        <div style="font-size: 1.25rem; font-weight: 700; color: var(--color-accent-primary); margin-bottom: 0.5rem;">Generation Debugger</div>
        <div style="color: var(--color-text-secondary); font-size: 1rem;">ASCII-based generation debug & visualizer</div>
    </div>
    <div class="terminal-body" style="padding: 1.5rem;">
        <div class="status-panel mb-3">
            <div class="message-bar message-bar-info mb-2">
                <span class="message-icon">?</span>
                <span class="message-content">
                    <strong>Status:</strong> <span class="status-text">@status.PadRight(40)</span><br />
                    <strong>Step:</strong> <span class="step-text">@currentStep.PadRight(40)</span>
                </span>
            </div>
        </div>
        <div class="controls-panel mb-3">
            <div class="message-bar message-bar-info mb-2">
                <span class="message-content">
                    <strong>Controls:</strong> [F1] Start   [F2] Pause   [F3] Resume   [F4] Stop   [ESC] Exit
                </span>
            </div>
            <div class="button-row" style="display: flex; gap: 1rem;">
                <Button Appearance="accent" OnClick="StartGeneration" Disabled="@isRunning">Start</Button>
                <Button Appearance="neutral" OnClick="PauseGeneration" Disabled="@(!isRunning || isPaused)">Pause</Button>
                <Button Appearance="accent" OnClick="ResumeGeneration" Disabled="@(!isPaused)">Resume</Button>
                <Button Appearance="danger" OnClick="StopGeneration" Disabled="@(!isRunning && !isPaused)">Stop</Button>
            </div>
        </div>
        <div class="logs-panel">
            <div class="message-bar message-bar-info mb-2">
                <span class="message-content"><strong>Generation Log</strong></span>
            </div>
            <div class="logs-content" style="background: var(--color-bg-tertiary); padding: 1rem; border-radius: var(--radius-md); max-height: 260px; overflow-y:auto;">
                @foreach (var log in logs)
                {
                    <div class="log-entry" style="color: var(--color-text-primary);">@log.PadRight(72)</div>
                }
                @if (!logs.Any())
                {
                    <div class="log-entry" style="color: var(--color-text-muted);">[SYSTEM] Ready for generation...</div>
                }
            </div>
        </div>
    </div>
</Card>

@code {
    private bool isRunning = false;
    private bool isPaused = false;
    private string status = "IDLE";
    private string currentStep = "WAITING";
    private List<string> logs = new();
    private CancellationTokenSource? _cancellationTokenSource;

    private async Task StartGeneration()
    {
        if (isRunning) return;

        isRunning = true;
        isPaused = false;
        status = "RUNNING";
        currentStep = "INITIALIZING";
        logs.Clear();
        logs.Add("[SYSTEM] Generation started...");
        StateHasChanged();

        _cancellationTokenSource = new CancellationTokenSource();

        try
        {
            await foreach (var step in GenerationService.RunGenerationAsync(_cancellationTokenSource.Token))
            {
                if (_cancellationTokenSource.Token.IsCancellationRequested) break;

                currentStep = step.ToUpper();
                logs.Add($"[STEP] {step}");
                StateHasChanged();

                await Task.Delay(900, _cancellationTokenSource.Token);
            }

            if (!_cancellationTokenSource.Token.IsCancellationRequested)
            {
                status = "COMPLETED";
                currentStep = "FINISHED";
                logs.Add("[SYSTEM] Generation completed successfully!");
            }
        }
        catch (OperationCanceledException)
        {
            status = "CANCELLED";
            logs.Add("[SYSTEM] Generation cancelled by user.");
        }
        catch (Exception ex)
        {
            status = "ERROR";
            logs.Add($"[ERROR] {ex.Message}");
        }
        finally
        {
            isRunning = false;
            isPaused = false;
            _cancellationTokenSource?.Dispose();
            _cancellationTokenSource = null;
            StateHasChanged();
        }
    }

    private void PauseGeneration()
    {
        if (!isRunning || isPaused) return;

        isPaused = true;
        status = "PAUSED";
        logs.Add("[SYSTEM] Generation paused.");
        _cancellationTokenSource?.Cancel();
        StateHasChanged();
    }

    private async Task ResumeGeneration()
    {
        if (!isPaused) return;

        isPaused = false;
        status = "RESUMING";
        logs.Add("[SYSTEM] Resuming generation...");
        StateHasChanged();

        _cancellationTokenSource = new CancellationTokenSource();

        try
        {
            var remainingSteps = new[] { "Resuming Process", "Continuing Tasks", "Finalizing Resume" };

            foreach (var step in remainingSteps)
            {
                if (_cancellationTokenSource.Token.IsCancellationRequested) break;

                currentStep = step.ToUpper();
                logs.Add($"[STEP] {step}");
                StateHasChanged();
                await Task.Delay(800, _cancellationTokenSource.Token);
            }

            if (!_cancellationTokenSource.Token.IsCancellationRequested)
            {
                status = "RUNNING";
                logs.Add("[SYSTEM] Generation resumed successfully!");
            }
        }
        catch (OperationCanceledException)
        {
            status = "CANCELLED";
            logs.Add("[SYSTEM] Resume cancelled.");
        }
        finally
        {
            if (!isPaused)
            {
                isRunning = false;
                _cancellationTokenSource?.Dispose();
                _cancellationTokenSource = null;
            }
            StateHasChanged();
        }
    }

    private void StopGeneration()
    {
        if (!isRunning && !isPaused) return;

        _cancellationTokenSource?.Cancel();
        isRunning = false;
        isPaused = false;
        status = "STOPPED";
        currentStep = "HALTED";
        logs.Add("[SYSTEM] Generation stopped by user.");
        StateHasChanged();
    }
}
#!/usr/bin/env pwsh
# Quick LLamaSharp Test Runner
# Tests if LLamaSharp is generating actual text

Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  Quick LLamaSharp Text Generation Test" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Check if model exists
$modelPath = "$env:APPDATA\SoloAdventureSystem\models\phi-3-mini-q4.gguf"
if (Test-Path $modelPath) {
    $size = (Get-Item $modelPath).Length / 1GB
    Write-Host "? Model found: $([math]::Round($size, 2)) GB" -ForegroundColor Green
    
    # Check if size is reasonable (should be ~2GB)
    if ($size -lt 1.8) {
        Write-Host "??  Model file seems corrupted (too small)" -ForegroundColor Yellow
        Write-Host ""
        $response = Read-Host "Delete and re-download? (y/n)"
        if ($response -eq 'y') {
            Remove-Item $modelPath -Force
            Write-Host "? Deleted corrupted model" -ForegroundColor Green
        }
    }
} else {
    Write-Host "?? Model not found - will download on first run" -ForegroundColor Yellow
}

Write-Host ""
Write-Host "Running validation tool..." -ForegroundColor Cyan
Write-Host ""

# Change to validation tool directory
Push-Location SoloAdventureSystem.ValidationTool

try {
    # Run the validation tool
    dotnet run
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host ""
        Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Green
        Write-Host "  ? SUCCESS - Check output above for generated text" -ForegroundColor Green
        Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Green
    } else {
        Write-Host ""
        Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Red
        Write-Host "  ? FAILED - See errors above" -ForegroundColor Red
        Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Red
        Write-Host ""
        Write-Host "Try deleting the model and re-running:" -ForegroundColor Yellow
        Write-Host "  Remove-Item `"$modelPath`" -Force" -ForegroundColor White
        Write-Host "  .\test-llamasharp.ps1" -ForegroundColor White
    }
} finally {
    Pop-Location
}

Write-Host ""
Write-Host "Press any key to exit..."
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")

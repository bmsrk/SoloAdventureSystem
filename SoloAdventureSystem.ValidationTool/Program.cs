using System;
using System.IO;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using SoloAdventureSystem.ContentGenerator;
using SoloAdventureSystem.ContentGenerator.Adapters;
using SoloAdventureSystem.ContentGenerator.Configuration;
using SoloAdventureSystem.ContentGenerator.EmbeddedModel;
using SoloAdventureSystem.ContentGenerator.Utils;

namespace SoloAdventureSystem.Tools;

/// <summary>
/// Simple validation tool to check if LLamaSharp is working properly.
/// Run this to verify model download, loading, and text generation.
/// </summary>
class Program
{
    static async Task<int> Main(string[] args)
    {
        Console.WriteLine("???????????????????????????????????????????????????????????");
        Console.WriteLine("  LLamaSharp Validation Tool");
        Console.WriteLine("???????????????????????????????????????????????????????????");
        Console.WriteLine();

        var modelKey = args.Length > 0 ? args[0] : "phi-3-mini-q4";
        Console.WriteLine($"Testing model: {modelKey}");
        Console.WriteLine();

        try
        {
            // Setup services
            var services = new ServiceCollection();
            services.AddLogging(builder =>
            {
                builder.AddConsole();
                builder.SetMinimumLevel(LogLevel.Information);
            });

            services.Configure<AISettings>(options =>
            {
                options.Provider = "LLamaSharp";
                options.Model = modelKey;
                options.LLamaModelKey = modelKey;
                options.ContextSize = 2048;
                options.UseGPU = false;
                options.MaxInferenceThreads = 4;
            });

            var serviceProvider = services.BuildServiceProvider();

            // Step 1: Check model file
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine("? Step 1: Checking Model File                            ?");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            
            var modelPath = GGUFModelDownloader.GetModelPath(modelKey);
            Console.WriteLine($"Model path: {modelPath}");
            
            if (File.Exists(modelPath))
            {
                var fileInfo = new FileInfo(modelPath);
                Console.WriteLine($"? File exists: {PathHelper.FormatFileSize(fileInfo.Length)}");
                Console.WriteLine($"   Last modified: {fileInfo.LastWriteTime}");
            }
            else
            {
                Console.WriteLine("? File does not exist - will download");
            }
            Console.WriteLine();

            // Step 2: Download/Verify model
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine("? Step 2: Downloading/Verifying Model                    ?");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            
            var downloader = new GGUFModelDownloader(
                serviceProvider.GetRequiredService<ILogger<GGUFModelDownloader>>());
            
            var progress = new Progress<DownloadProgress>(p =>
            {
                if (p.PercentComplete % 10 == 0 || p.PercentComplete == 100)
                {
                    Console.WriteLine($"   Progress: {p.PercentComplete}% - {p.FormattedETA} remaining");
                }
            });

            var startTime = DateTime.UtcNow;
            modelPath = await downloader.EnsureModelAvailableAsync(modelKey, progress);
            var downloadTime = DateTime.UtcNow - startTime;
            
            Console.WriteLine($"? Model ready in {downloadTime.TotalSeconds:F1}s");
            Console.WriteLine();

            // Step 3: Initialize LLamaSharp
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine("? Step 3: Initializing LLamaSharp Adapter                ?");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            
            var settings = serviceProvider.GetRequiredService<IOptions<AISettings>>();
            var logger = serviceProvider.GetRequiredService<ILogger<LLamaSharpAdapter>>();
            
            using var adapter = new LLamaSharpAdapter(settings, logger);
            
            startTime = DateTime.UtcNow;
            await adapter.InitializeAsync();
            var initTime = DateTime.UtcNow - startTime;
            
            Console.WriteLine($"? Adapter initialized in {initTime.TotalSeconds:F1}s");
            Console.WriteLine();

            // Step 4: Generate test text
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine("? Step 4: Testing Text Generation                        ?");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            
            // Test 1: Room Description
            Console.WriteLine("Test 1: Room Description");
            Console.WriteLine("Prompt: \"Describe a cyberpunk room in 2 sentences.\"");
            Console.WriteLine();
            
            startTime = DateTime.UtcNow;
            var roomDesc = adapter.GenerateRoomDescription(
                "Describe a cyberpunk room in 2 sentences.", 
                42);
            var genTime1 = DateTime.UtcNow - startTime;
            
            Console.WriteLine("Generated text:");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine(roomDesc);
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine($"? Generated in {genTime1.TotalSeconds:F1}s");
            
            // Validate response quality
            if (string.IsNullOrWhiteSpace(roomDesc))
            {
                throw new InvalidOperationException("? Room description is empty!");
            }
            if (roomDesc.Length < 20)
            {
                throw new InvalidOperationException($"? Room description too short: {roomDesc.Length} chars");
            }
            Console.WriteLine($"? Response quality: {roomDesc.Length} characters");
            Console.WriteLine();
            
            // Test 2: NPC Bio
            Console.WriteLine("Test 2: NPC Biography");
            Console.WriteLine("Prompt: \"Create a short bio for a cyberpunk hacker named Raven.\"");
            Console.WriteLine();
            
            startTime = DateTime.UtcNow;
            var npcBio = adapter.GenerateNpcBio(
                "Create a short bio for a cyberpunk hacker named Raven.", 
                123);
            var genTime2 = DateTime.UtcNow - startTime;
            
            Console.WriteLine("Generated text:");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine(npcBio);
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine($"? Generated in {genTime2.TotalSeconds:F1}s");
            
            // Validate response
            if (string.IsNullOrWhiteSpace(npcBio))
            {
                throw new InvalidOperationException("? NPC bio is empty!");
            }
            if (npcBio.Length < 20)
            {
                throw new InvalidOperationException($"? NPC bio too short: {npcBio.Length} chars");
            }
            Console.WriteLine($"? Response quality: {npcBio.Length} characters");
            Console.WriteLine();
            
            // Test 3: Faction Description
            Console.WriteLine("Test 3: Faction Description");
            Console.WriteLine("Prompt: \"Describe a cyberpunk faction called 'The Neon Syndicate'.\"");
            Console.WriteLine();
            
            startTime = DateTime.UtcNow;
            var factionDesc = adapter.GenerateFactionFlavor(
                "Describe a cyberpunk faction called 'The Neon Syndicate'.", 
                456);
            var genTime3 = DateTime.UtcNow - startTime;
            
            Console.WriteLine("Generated text:");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine(factionDesc);
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine($"? Generated in {genTime3.TotalSeconds:F1}s");
            
            // Validate response
            if (string.IsNullOrWhiteSpace(factionDesc))
            {
                throw new InvalidOperationException("? Faction description is empty!");
            }
            if (factionDesc.Length < 20)
            {
                throw new InvalidOperationException($"? Faction description too short: {factionDesc.Length} chars");
            }
            Console.WriteLine($"? Response quality: {factionDesc.Length} characters");
            Console.WriteLine();
            
            var totalGenTime = genTime1 + genTime2 + genTime3;

            // Step 5: Summary
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine("  ? ALL TESTS PASSED - LLamaSharp is working correctly!");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine();
            Console.WriteLine("Summary:");
            Console.WriteLine($"  Model: {modelKey}");
            Console.WriteLine($"  Download/Verify: {downloadTime.TotalSeconds:F1}s");
            Console.WriteLine($"  Initialization: {initTime.TotalSeconds:F1}s");
            Console.WriteLine($"  Text Generation:");
            Console.WriteLine($"    - Room Description: {genTime1.TotalSeconds:F1}s ({roomDesc.Length} chars)");
            Console.WriteLine($"    - NPC Biography: {genTime2.TotalSeconds:F1}s ({npcBio.Length} chars)");
            Console.WriteLine($"    - Faction Description: {genTime3.TotalSeconds:F1}s ({factionDesc.Length} chars)");
            Console.WriteLine($"  Total Generation Time: {totalGenTime.TotalSeconds:F1}s");
            Console.WriteLine($"  Overall Total: {(downloadTime + initTime + totalGenTime).TotalSeconds:F1}s");
            Console.WriteLine();
            Console.WriteLine("? All 3 generation types working correctly!");
            Console.WriteLine();

            return 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine();
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine("  ? VALIDATION FAILED");
            Console.WriteLine("???????????????????????????????????????????????????????????");
            Console.WriteLine();
            Console.WriteLine($"Error: {ex.Message}");
            Console.WriteLine();
            Console.WriteLine("Troubleshooting:");
            Console.WriteLine("  1. Delete corrupted model:");
            Console.WriteLine($"     Remove-Item \"{GGUFModelDownloader.GetModelPath(modelKey)}\"");
            Console.WriteLine();
            Console.WriteLine("  2. Check disk space (need ~2-3 GB free)");
            Console.WriteLine();
            Console.WriteLine("  3. Check internet connection for model download");
            Console.WriteLine();
            Console.WriteLine("  4. Try a smaller model:");
            Console.WriteLine("     dotnet run -- tinyllama-q4");
            Console.WriteLine();
            Console.WriteLine("Stack trace:");
            Console.WriteLine(ex.StackTrace);
            Console.WriteLine();

            return 1;
        }
    }
}

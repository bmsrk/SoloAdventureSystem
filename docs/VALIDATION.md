# World Validation Flow Diagram

## High-Level Architecture

```
???????????????????????????????????????????????????????????????????
?                     WorldGeneratorUI                             ?
?  (User generates world with LLamaSharp or Stub provider)        ?
???????????????????????????????????????????????????????????????????
                         ?
                         ? 1. Generate()
                         ?
???????????????????????????????????????????????????????????????????
?                  SeededWorldGenerator                            ?
?  Generates: Rooms, NPCs, Factions, Lore, Story Nodes            ?
???????????????????????????????????????????????????????????????????
                         ?
                         ? 2. WorldGenerationResult
                         ?
???????????????????????????????????????????????????????????????????
?                     WorldValidator                               ?
?  Step 1: Structural Validation (Always Runs)                    ?
?  Step 2: Quality Validation (LLM-Powered, Optional)             ?
???????????????????????????????????????????????????????????????????
                         ?
                         ? 3. ValidationResult
                         ?
???????????????????????????????????????????????????????????????????
?                       User Feedback                              ?
?  • Quality Scores (0-100) for each category                     ?
?  • Warnings for low-quality content                             ?
?  • Confirmation dialog if score < 50                            ?
???????????????????????????????????????????????????????????????????
```

## Validation Process Detail

```
WorldValidator.ValidateQuality(result, theme)
?
?? 1. Run Basic Structural Validation
?   ?? Check world.json exists
?   ?? Check ? 3 rooms
?   ?? Check ? 1 faction
?   ?? Check ? 1 story node
?
?? 2. Room Quality Validation
?   ?? Select first 3 rooms (performance)
?   ?? For each room:
?   ?   ?? Build validation prompt
?   ?   ?? Call LLM: GenerateRoomDescription(prompt)
?   ?   ?? Parse score (0-100)
?   ?   ?? Warn if score < 60
?   ?? Calculate average room score
?
?? 3. NPC Quality Validation
?   ?? Select first 3 NPCs
?   ?? For each NPC:
?   ?   ?? Build validation prompt
?   ?   ?? Call LLM: GenerateNpcBio(prompt)
?   ?   ?? Parse score (0-100)
?   ?   ?? Warn if score < 60
?   ?? Calculate average NPC score
?
?? 4. Faction Quality Validation
?   ?? For each faction:
?   ?   ?? Build validation prompt
?   ?   ?? Call LLM: GenerateFactionFlavor(prompt)
?   ?   ?? Parse score (0-100)
?   ?   ?? Warn if score < 60
?   ?? Calculate average faction score
?
?? 5. Consistency Validation (No LLM)
?   ?? Check room connectivity
?   ?   ?? Warn if disconnected rooms found (-20 pts)
?   ?? Check NPC-faction references
?   ?   ?? Warn if invalid references (-15 pts)
?   ?? Check room-NPC references
?   ?   ?? Warn if missing NPCs (-10 pts)
?   ?? Calculate consistency score (100 - penalties)
?
?? 6. Calculate Overall Score
    ?? Average all category scores
    ?? Mark invalid if overall < 50
    ?? Return ValidationResult
        ?? IsValid: bool
        ?? Errors: List<string>
        ?? Warnings: List<string>
        ?? Metrics: QualityMetrics
            ?? RoomQualityScore: int
            ?? NpcQualityScore: int
            ?? FactionQualityScore: int
            ?? ConsistencyScore: int
            ?? OverallScore: int
```

## Validation Prompt Flow

```
Room Validation Example:
????????????????????????????????????????????????????????????????
? User Input: Room "Data Vault"                                ?
? Description: "Humming servers fill the room."                ?
????????????????????????????????????????????????????????????????
                            ?
                            ?
????????????????????????????????????????????????????????????????
? Validation Prompt Template:                                  ?
? "Rate this room description on a scale of 0-100:             ?
?  - Is it vivid and immersive? (30 points)                    ?
?  - Does it match the Cyberpunk theme? (25 points)            ?
?  - Does it include sensory details? (25 points)              ?
?  - Is it well-written? (20 points)                           ?
?                                                               ?
?  Room Name: Data Vault                                       ?
?  Description: Humming servers fill the room.                 ?
?                                                               ?
?  Respond with ONLY a number 0-100:"                          ?
????????????????????????????????????????????????????????????????
                            ?
                            ?
????????????????????????????????????????????????????????????????
? LLamaSharpAdapter.GenerateRoomDescription(prompt)            ?
? ?? LLamaInferenceEngine.Generate(...)                        ?
? ?? LLM processes prompt                                      ?
? ?? Returns: "45"                                             ?
????????????????????????????????????????????????????????????????
                            ?
                            ?
????????????????????????????????????????????????????????????????
? Parse & Store Score:                                         ?
? ?? Extract number: 45                                        ?
? ?? Clamp to 0-100 range                                      ?
? ?? Check threshold: 45 < 60                                  ?
? ?? Add warning: "Room 'Data Vault' has low quality: 45/100"  ?
????????????????????????????????????????????????????????????????
```

## Quality Score Calculation

```
Room Quality Criteria (0-100 total):
???????????????????????????????????????
? Vividness & Immersion    ? 30 pts  ?
? Theme Consistency        ? 25 pts  ?
? Sensory Details          ? 25 pts  ?
? Writing Quality          ? 20 pts  ?
???????????????????????????????????????

NPC Quality Criteria (0-100 total):
???????????????????????????????????????
? Personality              ? 30 pts  ?
? Theme Consistency        ? 25 pts  ?
? Backstory                ? 25 pts  ?
? Memorability             ? 20 pts  ?
???????????????????????????????????????

Faction Quality Criteria (0-100 total):
???????????????????????????????????????
? Goals & Ideology         ? 30 pts  ?
? Theme Consistency        ? 25 pts  ?
? Conflicts                ? 25 pts  ?
? Coherence                ? 20 pts  ?
???????????????????????????????????????

Consistency Score (100 - penalties):
???????????????????????????????????????
? Disconnected Rooms       ? -20 pts ?
? Invalid Faction Refs     ? -15 pts ?
? Missing NPC Refs         ? -10 pts ?
???????????????????????????????????????

Overall Score:
???????????????????????????????????????
? Average of all 4 category scores    ?
? (Room + NPC + Faction + Consistency)?
?              ÷ 4                     ?
???????????????????????????????????????
```

## User Experience Flow

```
User clicks [Generate] ? World Generation Starts
                              ?
                              ?
                    ????????????????????
                    ?  Generating...   ? ? Progress: 0-50%
                    ?  (Rooms, NPCs,   ?
                    ?   Factions, etc) ?
                    ????????????????????
                             ?
                             ?
                    ????????????????????
                    ?   Validating     ? ? Progress: 70%
                    ?   Structure      ?
                    ????????????????????
                             ?
                             ?
         ?????????????????????????????????????
         ? LLamaSharp Provider?              ?
         ?????????????????????????????????????
             ? Yes                       ? No (Stub)
             ?                           ?
    ????????????????????       ????????????????????
    ?  Validating      ?       ?  Skip Quality    ?
    ?  Quality (LLM)   ?       ?  Validation      ?
    ?  Progress: 75%   ?       ????????????????????
    ????????????????????                ?
             ?                           ?
             ?                           ?
    ????????????????????                ?
    ? Show Quality     ?                ?
    ? Scores in Log    ?                ?
    ????????????????????                ?
             ?                           ?
             ?                           ?
    ????????????????????                ?
    ? Overall Score    ?                ?
    ? < 50?            ?                ?
    ????????????????????                ?
        ? Yes      ? No                 ?
        ?          ?                    ?
   ???????????  ???????????            ?
   ? Confirm ?  ? Export  ?            ?
   ? Dialog  ?  ? World   ??????????????
   ???????????  ???????????
       ? ?           ?
Cancel ? ? Save      ?
       ? ? Anyway    ?
       ? ?           ?
    [Cancel]    [Success!]
```

## Code Integration Points

```
SeededWorldGenerator.Generate()
    ?
    ?? Generates world content
    ?  ?? Returns WorldGenerationResult
    ?
WorldGeneratorUI.GenerateWorldAsync()
    ?
    ?? Calls generator.Generate()
    ?? Calls validator.Validate(result)           ? Basic validation
    ?
    ?? If LLamaSharp:
    ?   ?? Create validator with SLM adapter
    ?   ?? Call validator.ValidateQuality(result, theme)
    ?   ?? Log quality scores
    ?   ?? If score < 50: Show confirmation dialog
    ?   ?? User decides: Continue or Cancel
    ?
    ?? Export world to zip file
```

## Summary

The validation system provides **multi-layered quality assurance**:

1. **Structural Validation** (Always): Ensures world is well-formed
2. **LLM Quality Scoring** (Optional): Evaluates content quality
3. **Consistency Checks** (Always): Validates internal references
4. **User Feedback** (Interactive): Shows scores and allows override

This creates a **robust, user-friendly** validation experience that helps generate better worlds while maintaining flexibility and performance.
